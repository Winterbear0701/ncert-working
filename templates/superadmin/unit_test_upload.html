{% extends 'base_new.html' %}
{% load static %}

{% block title %}Upload Unit Test - Admin{% endblock %}

{% block extra_css %}
<style>
    .form-card {
        animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .drop-zone {
        border: 3px dashed #cbd5e0;
        transition: all 0.3s ease;
    }
    .drop-zone:hover {
        border-color: #4299e1;
        background-color: #ebf8ff;
    }
    .drop-zone.dragover {
        border-color: #3182ce;
        background-color: #bee3f8;
        transform: scale(1.02);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 form-card">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-4xl font-bold text-gray-900 mb-2">
                            <i class="fas fa-cloud-upload-alt text-green-600 mr-2"></i>
                            Upload Unit Test Questions
                        </h1>
                        <p class="text-gray-600">Upload a PDF or Word document with questions and model answers</p>
                    </div>
                    <a href="{% url 'superadmin:unit_test_list' %}" 
                       class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i>
                        <span class="font-semibold">Back</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Form Card -->
        <div class="bg-white rounded-xl shadow-lg p-8 form-card">
            <form method="POST" enctype="multipart/form-data" action="{% url 'superadmin:unit_test_upload_questions' %}" class="space-y-6">
                {% csrf_token %}

                <!-- Metadata Section -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-200">
                    <h2 class="text-xl font-bold text-blue-900 mb-4">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        Test Metadata
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Class Name -->
                        <div>
                            <label for="class_name" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-graduation-cap text-purple-500 mr-2"></i>
                                Class/Grade *
                            </label>
                            <input type="text" 
                                   id="class_name" 
                                   name="class_name" 
                                   required
                                   placeholder="e.g., Class 9"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        </div>

                        <!-- Subject -->
                        <div>
                            <label for="subject_name" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-book-open text-green-500 mr-2"></i>
                                Subject *
                            </label>
                            <input type="text" 
                                   id="subject_name" 
                                   name="subject_name" 
                                   required
                                   placeholder="e.g., Science"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        </div>

                        <!-- Units -->
                        <div>
                            <label for="units" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-list-ol text-orange-500 mr-2"></i>
                                Units/Topics *
                            </label>
                            <input type="text" 
                                   id="units" 
                                   name="units" 
                                   required
                                   placeholder="e.g., Unit 1, Unit 2"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        </div>

                        <!-- Chapter -->
                        <div>
                            <label for="chapter_id" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-book text-indigo-500 mr-2"></i>
                                Chapter *
                            </label>
                            <select id="chapter_id" 
                                    name="chapter_id" 
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                                <option value="">-- Select Chapter --</option>
                                {% for chapter in chapters %}
                                <option value="{{ chapter.id }}">{{ chapter.chapter_number }} - {{ chapter.chapter_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- File Upload Section -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-4">
                        <i class="fas fa-file-upload text-blue-500 mr-2"></i>
                        Upload Document *
                    </label>
                    
                    <!-- Drop Zone -->
                    <div id="dropZone" class="drop-zone relative rounded-lg p-12 text-center bg-gray-50">
                        <input type="file" 
                               id="fileInput" 
                               name="document" 
                               accept=".pdf,.doc,.docx"
                               required
                               class="hidden">
                        
                        <div id="dropZoneContent">
                            <div class="mb-4">
                                <i class="fas fa-cloud-upload-alt text-6xl text-gray-400"></i>
                            </div>
                            <p class="text-lg font-semibold text-gray-700 mb-2">
                                Drag and drop your file here
                            </p>
                            <p class="text-sm text-gray-500 mb-4">
                                or click to browse
                            </p>
                            <button type="button" 
                                    onclick="document.getElementById('fileInput').click()"
                                    class="px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-all shadow-md hover:shadow-lg font-semibold">
                                <i class="fas fa-folder-open mr-2"></i>
                                Browse Files
                            </button>
                            <p class="text-xs text-gray-500 mt-4">
                                Supported formats: PDF, DOC, DOCX (Max 10MB)
                            </p>
                        </div>

                        <div id="fileInfo" class="hidden">
                            <div class="inline-flex items-center gap-4 bg-white px-6 py-4 rounded-lg shadow-md">
                                <i class="fas fa-file-alt text-4xl text-blue-500"></i>
                                <div class="text-left">
                                    <p id="fileName" class="font-semibold text-gray-900"></p>
                                    <p id="fileSize" class="text-sm text-gray-500"></p>
                                </div>
                                <button type="button" 
                                        onclick="clearFile()"
                                        class="ml-4 text-red-500 hover:text-red-700 transition">
                                    <i class="fas fa-times-circle text-2xl"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Format Info -->
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-semibold text-yellow-800 mb-2">Document Format Requirements</h3>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                <li><strong>• Questions:</strong> Clearly numbered (Q1, Q2, etc.)</li>
                                <li><strong>• Marks:</strong> Indicated after each question (e.g., [5 marks])</li>
                                <li><strong>• Model Answers:</strong> Labeled as "Answer:", "Model Answer:", or "Solution:"</li>
                                <li><strong>• Structure:</strong> One question and answer per section</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4 pt-6 border-t border-gray-200">
                    <button type="submit" 
                            class="flex-1 px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all shadow-lg hover:shadow-xl font-semibold text-lg transform hover:scale-105">
                        <i class="fas fa-cloud-upload-alt mr-2"></i>
                        Upload & Parse Document
                    </button>
                    <a href="{% url 'superadmin:unit_test_list' %}" 
                       class="px-8 py-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all font-semibold text-lg">
                        <i class="fas fa-times mr-2"></i>
                        Cancel
                    </a>
                </div>
            </form>
        </div>

        <!-- Help Card -->
        <div class="mt-8 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl shadow-lg p-6 border border-green-200">
            <h3 class="text-lg font-bold text-green-900 mb-3">
                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                Example Document Format
            </h3>
            <div class="bg-white rounded-lg p-4 border border-green-200 font-mono text-sm">
                <p class="text-gray-700 mb-2"><strong class="text-blue-600">Q1.</strong> Explain Newton's First Law of Motion. <span class="text-orange-600">[5 marks]</span></p>
                <p class="text-gray-700 mb-4"><strong class="text-green-600">Answer:</strong> Newton's First Law states that an object at rest stays at rest...</p>
                
                <p class="text-gray-700 mb-2"><strong class="text-blue-600">Q2.</strong> What is photosynthesis? <span class="text-orange-600">[3 marks]</span></p>
                <p class="text-gray-700"><strong class="text-green-600">Model Answer:</strong> Photosynthesis is the process by which green plants...</p>
            </div>
        </div>

    </div>
</div>

<script>
// File upload handling
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const dropZoneContent = document.getElementById('dropZoneContent');
const fileInfo = document.getElementById('fileInfo');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone when dragging over it
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
});

// Handle dropped files
dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    fileInput.files = files;
    handleFiles(files);
}

// Handle file selection
fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

function handleFiles(files) {
    if (files.length > 0) {
        const file = files[0];
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        dropZoneContent.classList.add('hidden');
        fileInfo.classList.remove('hidden');
    }
}

function clearFile() {
    fileInput.value = '';
    dropZoneContent.classList.remove('hidden');
    fileInfo.classList.add('hidden');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Click anywhere in drop zone to open file dialog
dropZone.addEventListener('click', (e) => {
    if (e.target !== fileInput && !e.target.closest('button')) {
        fileInput.click();
    }
});
</script>
{% endblock %}
