{% extends 'base_new.html' %}
{% load static %}

{% block title %}Create Unit Test - Admin{% endblock %}

{% block extra_css %}
<style>
    .form-card {
        animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .question-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    .question-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border-left-color: #3B82F6;
    }
    .mark-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 50px;
        height: 32px;
        padding: 0 12px;
        font-weight: 600;
        border-radius: 6px;
    }
    .mark-1 { background: #E0F2FE; color: #0369A1; }
    .mark-2 { background: #DBEAFE; color: #1E40AF; }
    .mark-3 { background: #DDD6FE; color: #5B21B6; }
    .mark-5 { background: #FCE7F3; color: #9F1239; }
    .mark-other { background: #FEF3C7; color: #92400E; }
    
    .step-indicator {
        display: flex;
        align-items: center;
        margin-bottom: 2rem;
    }
    .step {
        flex: 1;
        text-align: center;
        position: relative;
    }
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #E5E7EB;
        color: #6B7280;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    .step.active .step-number {
        background: #3B82F6;
        color: white;
    }
    .step.completed .step-number {
        background: #10B981;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 py-8">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 form-card">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-4xl font-bold text-gray-900 mb-2">
                            <i class="fas fa-file-alt text-blue-600 mr-2"></i>
                            Create Unit Test
                        </h1>
                        <p class="text-gray-600">Create a subjective test with questions organized by marks</p>
                    </div>
                    <a href="{% url 'superadmin:unit_test_list' %}" 
                       class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i>
                        <span class="font-semibold">Back</span>
                    </a>
                </div>
            </div>
        </div>

        <form id="unitTestForm" method="POST" action="{% url 'superadmin:unit_test_create' %}">
            {% csrf_token %}
            <input type="hidden" id="total_marks_type_hidden" name="total_marks_type" value="80">
            
            <!-- Step 1: Basic Information -->
            <div class="bg-white rounded-xl shadow-lg p-8 form-card mb-6" id="step1">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">
                    <span class="text-blue-600">Step 1:</span> Basic Information
                </h2>

                <div class="space-y-6">
                    <!-- Test Title -->
                    <div>
                        <label for="title" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-heading text-blue-500 mr-2"></i>
                            Test Title *
                        </label>
                        <input type="text" 
                               id="title" 
                               name="title" 
                               required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., Chapter 5 - Motion and Time Unit Test">
                    </div>

                    <!-- Class Selection -->
                    <div>
                        <label for="class" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-school text-green-500 mr-2"></i>
                            Class *
                        </label>
                        <select id="class" name="class" required 
                                onchange="loadSubjects(this.value)"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Class</option>
                            {% for class_num in class_list %}
                            <option value="{{ class_num }}">{{ class_num }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Subject Selection -->
                    <div>
                        <label for="subject" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-book text-indigo-500 mr-2"></i>
                            Subject *
                        </label>
                        <select id="subject" name="subject" required 
                                onchange="loadChapters()"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Subject</option>
                        </select>
                    </div>

                    <!-- Chapter Selection -->
                    <div>
                        <label for="chapters" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-bookmark text-purple-500 mr-2"></i>
                            Chapters * <span class="text-xs text-gray-500">(Hold Ctrl/Cmd to select multiple)</span>
                        </label>
                        <select id="chapters" name="chapters" multiple required size="6"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="" disabled class="text-gray-500">Select class and subject first</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            <span id="chapterCount">No chapters selected</span>
                        </p>
                    </div>

                    <!-- Grid for Marks, Duration, Passing -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="total_marks_type" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-star text-yellow-500 mr-2"></i>
                                Total Marks *
                            </label>
                            <select id="total_marks_type" name="total_marks_type" required onchange="updateTestType()"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="0">Practice Test (0 marks)</option>
                                <option value="50">Half Test (50 marks)</option>
                                <option value="80" selected>Full Test (80 marks)</option>
                            </select>
                            <input type="hidden" id="total_marks" name="total_marks" value="80">
                            <p class="text-xs text-gray-500 mt-1" id="distributionInfo">20×1 + 6×2 + 7×3 + 3×4 + 3×5</p>
                        </div>

                        <div>
                            <label for="duration_minutes" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-clock text-orange-500 mr-2"></i>
                                Duration (min) *
                            </label>
                            <input type="number" id="duration_minutes" name="duration_minutes" value="60" min="1" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label for="passing_marks" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-check-double text-green-500 mr-2"></i>
                                Passing Marks *
                            </label>
                            <input type="number" id="passing_marks" name="passing_marks" value="32" min="0" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">40% of total marks</p>
                        </div>
                    </div>

                    <button type="button" onclick="goToStep2()" 
                            class="w-full px-8 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-all shadow-lg font-semibold text-lg">
                        Next: Add Questions <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Add Questions -->
            <div class="bg-white rounded-xl shadow-lg p-8 form-card hidden" id="step2">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">
                        <span class="text-blue-600">Step 2:</span> Add Questions
                    </h2>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">Current / Target:</div>
                        <div class="flex items-baseline gap-2">
                            <div class="text-3xl font-bold" id="displayTotalMarks">0</div>
                            <div class="text-2xl text-gray-400">/</div>
                            <div class="text-2xl text-gray-600" id="targetMarks">80</div>
                        </div>
                    </div>
                </div>

                <!-- Distribution Status -->
                <div id="distributionStatus" class="mb-6">
                    <!-- Status will be inserted here -->
                </div>

                <!-- Question Type Selector -->
                <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                        <i class="fas fa-star text-yellow-500 mr-2"></i>
                        Select Question Mark Value:
                    </label>
                    <div class="flex flex-wrap gap-3">
                        <button type="button" onclick="selectMarkType(1)" 
                                class="mark-button px-6 py-3 bg-white border-2 border-blue-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all font-semibold">
                            <i class="fas fa-star text-blue-500 mr-1"></i> 1 Mark
                        </button>
                        <button type="button" onclick="selectMarkType(2)" 
                                class="mark-button px-6 py-3 bg-white border-2 border-indigo-200 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-all font-semibold">
                            <i class="fas fa-star text-indigo-500 mr-1"></i> 2 Marks
                        </button>
                        <button type="button" onclick="selectMarkType(3)" 
                                class="mark-button px-6 py-3 bg-white border-2 border-purple-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all font-semibold">
                            <i class="fas fa-star text-purple-500 mr-1"></i> 3 Marks
                        </button>
                        <button type="button" onclick="selectMarkType(4)" 
                                class="mark-button px-6 py-3 bg-white border-2 border-pink-200 rounded-lg hover:border-pink-500 hover:bg-pink-50 transition-all font-semibold">
                            <i class="fas fa-star text-pink-500 mr-1"></i> 4 Marks
                        </button>
                        <button type="button" onclick="selectMarkType(5)" 
                                class="mark-button px-6 py-3 bg-white border-2 border-rose-200 rounded-lg hover:border-rose-500 hover:bg-rose-50 transition-all font-semibold">
                            <i class="fas fa-star text-rose-500 mr-1"></i> 5 Marks
                        </button>
                        <button type="button" onclick="showCustomMarkInput()" 
                                class="mark-button px-6 py-3 bg-white border-2 border-yellow-200 rounded-lg hover:border-yellow-500 hover:bg-yellow-50 transition-all font-semibold">
                            <i class="fas fa-edit text-yellow-600 mr-1"></i> Custom
                        </button>
                    </div>
                </div>

                <!-- Saved Questions Search -->
                <div class="mb-6 bg-white border-2 border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h3 class="text-sm font-semibold flex items-center">
                                <i class="fas fa-database text-blue-500 mr-2"></i>
                                Search Saved Questions from Question Bank
                            </h3>
                            <p class="text-xs text-gray-500">Reuse previously saved questions from the centralized database</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3">
                        <select id="savedClass" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">All Classes</option>
                            {% for class_num in class_list %}
                            <option value="{{ class_num }}">{{ class_num }}</option>
                            {% endfor %}
                        </select>
                        <input id="savedSubject" type="text" placeholder="Subject (optional)" 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <input id="savedChapterId" type="number" placeholder="Chapter ID (optional)" 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <input id="savedQuery" type="text" placeholder="Search text..." 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <button type="button" onclick="searchSavedQuestions()" 
                            class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all font-semibold mb-3">
                        <i class="fas fa-search mr-2"></i> Search Questions
                    </button>

                    <div id="savedResults" class="space-y-3 max-h-64 overflow-auto">
                        <!-- results inserted here -->
                        <div class="text-sm text-gray-400 text-center py-4">
                            <i class="fas fa-info-circle mr-2"></i>
                            Use the search filters above to find saved questions
                        </div>
                    </div>
                </div>

                <!-- Add Question Form -->
                <div class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-6" id="questionInputArea" style="display:none;">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-question-circle text-blue-500 mr-2"></i>
                                Question *
                            </label>
                            <textarea id="questionText" rows="3" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                      placeholder="Enter the question here..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                Model Answer *
                            </label>
                            <textarea id="modelAnswer" rows="4" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                      placeholder="Enter the expected answer..."></textarea>
                        </div>

                        <div class="hidden" id="customMarkDiv">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-star text-yellow-500 mr-2"></i>
                                Marks *
                            </label>
                            <input type="number" id="customMarkValue" min="1" max="20" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Enter marks (1-20)">
                        </div>

                        <button type="button" onclick="addQuestion()" 
                                class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all font-semibold">
                            <i class="fas fa-plus mr-2"></i>
                            Add Question
                        </button>
                    </div>
                </div>

                <!-- Questions List -->
                <div id="questionsList" class="space-y-4 mb-6">
                    <!-- Questions will be added here dynamically -->
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4 pt-6 border-t border-gray-200">
                    <button type="button" onclick="goToStep1()" 
                            class="px-8 py-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all font-semibold">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back
                    </button>
                    <button type="submit" 
                            class="flex-1 px-8 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-all shadow-lg font-semibold text-lg">
                        <i class="fas fa-save mr-2"></i>
                        Create Test
                    </button>
                </div>
            </div>
        </form>

    </div>
</div>

<script>
let questions = [];
let currentMarkType = null;
let questionCounter = 1;
let testType = 80; // Default to full test
let requiredDistribution = {
    80: {1: 20, 2: 6, 3: 7, 4: 3, 5: 3},  // Full test
    50: {1: 15, 2: 4, 3: 4, 4: 2, 5: 2},  // Half test
    0: {}  // Practice test - no restrictions
};

// Update test type and requirements
function updateTestType() {
    const select = document.getElementById('total_marks_type');
    testType = parseInt(select.value);
    document.getElementById('total_marks').value = testType;
    document.getElementById('total_marks_type_hidden').value = testType;
    
    // Update passing marks suggestion
    const passingInput = document.getElementById('passing_marks');
    if (testType > 0) {
        passingInput.value = Math.round(testType * 0.4); // 40% of total
    } else {
        passingInput.value = 0;
    }
    
    // Update distribution info
    const infoEl = document.getElementById('distributionInfo');
    if (testType === 80) {
        infoEl.textContent = '20×1 + 6×2 + 7×3 + 3×4 + 3×5 = 80 marks';
        infoEl.className = 'text-xs text-green-600 mt-1 font-semibold';
    } else if (testType === 50) {
        infoEl.textContent = '15×1 + 4×2 + 4×3 + 2×4 + 2×5 = 50 marks';
        infoEl.className = 'text-xs text-blue-600 mt-1 font-semibold';
    } else {
        infoEl.textContent = 'No mark restrictions for practice test';
        infoEl.className = 'text-xs text-gray-500 mt-1';
    }
}

// Load subjects based on class
function loadSubjects(classNum) {
    if (!classNum) return;
    
    const subjectSelect = document.getElementById('subject');
    const chaptersSelect = document.getElementById('chapters');
    
    console.log('loadSubjects called for class:', classNum);
    
    // Reset dependent dropdowns
    subjectSelect.innerHTML = '<option value="">Loading subjects...</option>';
    chaptersSelect.innerHTML = '<option value="" disabled>Select subject first</option>';
    
    const classNumber = classNum.replace(/[^0-9]/g, '');
    const url = `/superadmin/api/get-subjects/?class=${encodeURIComponent(classNumber)}`;
    
    console.log('Fetching subjects from:', url);
    
    fetch(url)
        .then(res => {
            console.log('Subjects response status:', res.status);
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            console.log('Subjects data received:', data);
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            if (data.subjects && data.subjects.length > 0) {
                data.subjects.forEach(subject => {
                    subjectSelect.innerHTML += `<option value="${subject}">${subject}</option>`;
                });
                console.log(`Added ${data.subjects.length} subjects to dropdown`);
            } else {
                subjectSelect.innerHTML += '<option value="" disabled>No subjects found</option>';
                console.warn('No subjects found in response');
            }
        })
        .catch(err => {
            console.error('Error loading subjects:', err);
            subjectSelect.innerHTML = `<option value="">Error: ${err.message}</option>`;
        });
}

// Load chapters based on class and subject
function loadChapters() {
    const classNum = document.getElementById('class').value;
    const subject = document.getElementById('subject').value;
    const chaptersSelect = document.getElementById('chapters');
    
    console.log('loadChapters called:', {classNum, subject});
    
    if (!classNum || !subject) {
        chaptersSelect.innerHTML = '<option value="" disabled>Select class and subject first</option>';
        updateChapterCount();
        return;
    }
    
    chaptersSelect.innerHTML = '<option value="" disabled>Loading chapters...</option>';
    
    // Extract just the number from "Class X" format
    const classNumber = classNum.replace(/[^0-9]/g, '');
    const url = `/superadmin/api/get-chapters/?class=${encodeURIComponent(classNumber)}&subject=${encodeURIComponent(subject)}`;
    
    console.log('Fetching chapters from:', url);
    
    fetch(url)
        .then(res => {
            console.log('Response status:', res.status);
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            console.log('Chapters data received:', data);
            chaptersSelect.innerHTML = '';
            if (data.chapters && data.chapters.length > 0) {
                data.chapters.forEach(chapter => {
                    chaptersSelect.innerHTML += `<option value="${chapter.id}">${chapter.name}</option>`;
                });
                console.log(`Added ${data.chapters.length} chapters to dropdown`);
            } else {
                chaptersSelect.innerHTML = '<option value="" disabled>No chapters found for this subject</option>';
                console.warn('No chapters found in response');
            }
            updateChapterCount();
        })
        .catch(err => {
            console.error('Error loading chapters:', err);
            chaptersSelect.innerHTML = `<option value="" disabled>Error: ${err.message}</option>`;
            updateChapterCount();
        });
}

// Update chapter count display
function updateChapterCount() {
    const chaptersSelect = document.getElementById('chapters');
    const selectedCount = chaptersSelect.selectedOptions.length;
    const countEl = document.getElementById('chapterCount');
    
    if (selectedCount === 0) {
        countEl.textContent = 'No chapters selected';
        countEl.className = 'text-xs text-gray-500 mt-1';
    } else {
        countEl.textContent = `${selectedCount} chapter${selectedCount > 1 ? 's' : ''} selected`;
        countEl.className = 'text-xs text-green-600 mt-1 font-semibold';
    }
}

// Listen to chapter selection changes
document.addEventListener('DOMContentLoaded', function() {
    const chaptersSelect = document.getElementById('chapters');
    if (chaptersSelect) {
        chaptersSelect.addEventListener('change', updateChapterCount);
    }
});

function goToStep2() {
    // Validate step 1
    const title = document.getElementById('title').value.trim();
    const classVal = document.getElementById('class').value;
    const subject = document.getElementById('subject').value;
    const chapters = document.getElementById('chapters').selectedOptions;
    
    if (!title) {
        alert('Please enter a test title');
        document.getElementById('title').focus();
        return;
    }
    
    if (!classVal) {
        alert('Please select a class');
        document.getElementById('class').focus();
        return;
    }
    
    if (!subject) {
        alert('Please select a subject');
        document.getElementById('subject').focus();
        return;
    }
    
    if (chapters.length === 0) {
        alert('Please select at least one chapter');
        document.getElementById('chapters').focus();
        return;
    }
    
    // Update target marks display
    document.getElementById('targetMarks').textContent = testType;
    
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
    
    // Show initial distribution status
    showDistributionStatus();
    
    window.scrollTo(0, 0);
}

function goToStep1() {
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step1').classList.remove('hidden');
    window.scrollTo(0, 0);
}

function selectMarkType(marks) {
    currentMarkType = marks;
    document.getElementById('questionInputArea').style.display = 'block';
    document.getElementById('customMarkDiv').classList.add('hidden');
    document.getElementById('customMarkValue').value = '';
    
    // Highlight selected button
    document.querySelectorAll('.mark-button').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-blue-500');
    });
    event.target.classList.add('ring-2', 'ring-blue-500');
}

function showCustomMarkInput() {
    currentMarkType = 'custom';
    document.getElementById('questionInputArea').style.display = 'block';
    document.getElementById('customMarkDiv').classList.remove('hidden');
    
    // Highlight selected button
    document.querySelectorAll('.mark-button').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-blue-500');
    });
    event.target.classList.add('ring-2', 'ring-blue-500');
}

function addQuestion() {
    const questionText = document.getElementById('questionText').value.trim();
    const modelAnswer = document.getElementById('modelAnswer').value.trim();
    let marks = currentMarkType;
    
    if (currentMarkType === 'custom') {
        marks = parseInt(document.getElementById('customMarkValue').value);
        if (!marks || marks < 1 || marks > 20) {
            alert('Please enter a valid mark value (1-20)');
            return;
        }
    }
    
    if (!questionText || !modelAnswer) {
        alert('Please enter both question and answer');
        return;
    }
    
    const question = {
        id: questionCounter++,
        number: questions.length + 1,
        text: questionText,
        answer: modelAnswer,
        marks: marks
    };
    
    questions.push(question);
    renderQuestions();
    updateTotalMarks();
    
    // Clear inputs
    document.getElementById('questionText').value = '';
    document.getElementById('modelAnswer').value = '';
    document.getElementById('customMarkValue').value = '';
    
    // Show success message
    const totalMarks = questions.reduce((sum, q) => sum + q.marks, 0);
    if (testType > 0 && totalMarks === testType) {
        alert(`✅ Perfect! You've added all ${testType} marks worth of questions.`);
    }
}

function deleteQuestion(id) {
    if (!confirm('Are you sure you want to delete this question?')) {
        return;
    }
    
    questions = questions.filter(q => q.id !== id);
    // Renumber questions
    questions.forEach((q, index) => {
        q.number = index + 1;
    });
    renderQuestions();
    updateTotalMarks();
}

function getMarkBadgeClass(marks) {
    if (marks === 1) return 'mark-1';
    if (marks === 2) return 'mark-2';
    if (marks === 3) return 'mark-3';
    if (marks === 5) return 'mark-5';
    return 'mark-other';
}

function renderQuestions() {
    const container = document.getElementById('questionsList');
    
    if (questions.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12 text-gray-400 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                <i class="fas fa-question-circle text-6xl mb-4"></i>
                <p class="text-lg font-semibold">No questions added yet</p>
                <p class="text-sm">Select a mark value above and add your first question</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = questions.map(q => `
        <div class="question-card bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-lg font-bold text-gray-700">Q${q.number}.</span>
                        <span class="mark-badge ${getMarkBadgeClass(q.marks)}">${q.marks} Mark${q.marks > 1 ? 's' : ''}</span>
                    </div>
                    <div class="mb-3">
                        <div class="text-sm font-semibold text-gray-600 mb-1">
                            <i class="fas fa-question text-blue-500 mr-1"></i> Question:
                        </div>
                        <div class="text-gray-900 bg-blue-50 p-3 rounded border border-blue-100">${q.text}</div>
                    </div>
                    <div>
                        <div class="text-sm font-semibold text-gray-600 mb-1">
                            <i class="fas fa-check-circle text-green-500 mr-1"></i> Model Answer:
                        </div>
                        <div class="text-gray-700 text-sm bg-green-50 p-3 rounded border border-green-200">${q.answer}</div>
                    </div>
                </div>
                <button type="button" onclick="deleteQuestion(${q.id})" 
                        class="ml-4 text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded transition-all">
                    <i class="fas fa-trash text-xl"></i>
                </button>
            </div>
        </div>
    `).join('');
    
    // Add hidden inputs for form submission
    const form = document.getElementById('unitTestForm');
    // Remove old question inputs
    form.querySelectorAll('.question-data').forEach(el => el.remove());
    
    // Add new question inputs
    questions.forEach((q, index) => {
        const div = document.createElement('div');
        div.className = 'question-data hidden';
        div.innerHTML = `
            <input type="hidden" name="questions[${index}][text]" value="${q.text.replace(/"/g, '&quot;')}">
            <input type="hidden" name="questions[${index}][answer]" value="${q.answer.replace(/"/g, '&quot;')}">
            <input type="hidden" name="questions[${index}][marks]" value="${q.marks}">
        `;
        form.appendChild(div);
    });
}

function updateTotalMarks() {
    const total = questions.reduce((sum, q) => sum + q.marks, 0);
    const displayEl = document.getElementById('displayTotalMarks');
    displayEl.textContent = total;
    
    // Color coding based on target
    if (testType === 0) {
        displayEl.className = 'text-3xl font-bold text-gray-600';
    } else if (total === testType) {
        displayEl.className = 'text-3xl font-bold text-green-600';
    } else if (total < testType) {
        displayEl.className = 'text-3xl font-bold text-yellow-600';
    } else {
        displayEl.className = 'text-3xl font-bold text-red-600';
    }
    
    // Show distribution status
    showDistributionStatus();
}

function showDistributionStatus() {
    // Count questions by mark type
    const counts = {};
    questions.forEach(q => {
        counts[q.marks] = (counts[q.marks] || 0) + 1;
    });
    
    const required = requiredDistribution[testType] || {};
    const statusDiv = document.getElementById('distributionStatus');
    
    if (testType === 0 || Object.keys(required).length === 0) {
        statusDiv.innerHTML = '<div class="text-sm text-gray-500">No distribution requirements for practice test</div>';
        return;
    }
    
    let html = '<div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">';
    html += '<div class="text-sm font-semibold mb-2">Question Distribution Status:</div>';
    html += '<div class="grid grid-cols-5 gap-2 text-xs">';
    
    [1, 2, 3, 4, 5].forEach(mark => {
        const current = counts[mark] || 0;
        const req = required[mark] || 0;
        const isCorrect = current === req;
        const color = isCorrect ? 'text-green-600 bg-green-50 border-green-200' : 
                      current < req ? 'text-yellow-600 bg-yellow-50 border-yellow-200' : 
                      'text-red-600 bg-red-50 border-red-200';
        
        html += `
            <div class="p-2 border rounded ${color}">
                <div class="font-bold">${mark}-mark</div>
                <div>${current}/${req}</div>
            </div>
        `;
    });
    
    html += '</div></div>';
    statusDiv.innerHTML = html;
}

// Search saved questions from centralized DB
function searchSavedQuestions() {
    const q = document.getElementById('savedQuery').value.trim();
    const classVal = document.getElementById('savedClass').value;
    const subject = document.getElementById('savedSubject').value.trim();
    const chapterId = document.getElementById('savedChapterId').value;

    const params = new URLSearchParams();
    if (classVal) params.append('class', classVal.replace('Class ', ''));
    if (subject) params.append('subject', subject);
    if (chapterId) params.append('chapter_id', chapterId);
    if (q) params.append('q', q);

    const url = `/superadmin/api/get-saved-questions/?${params.toString()}`;
    const resultsDiv = document.getElementById('savedResults');
    resultsDiv.innerHTML = '<div class="text-sm text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Searching...</div>';

    fetch(url)
        .then(r => r.json())
        .then(data => {
            const questions = data.questions || [];
            if (questions.length === 0) {
                resultsDiv.innerHTML = '<div class="text-sm text-gray-400">No saved questions found. Try different filters.</div>';
                return;
            }

            resultsDiv.innerHTML = questions.map((s, idx) => `
                <div class="p-3 border rounded bg-white hover:bg-gray-50 transition-all flex justify-between items-start">
                    <div class="flex-1 pr-3">
                        <div class="text-sm font-semibold text-gray-800">${s.question}</div>
                        <div class="text-xs text-gray-600 mt-1 bg-gray-50 p-2 rounded">${s.answer}</div>
                        <div class="flex items-center gap-2 mt-2 text-xs">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded">${s.class}</span>
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded">${s.subject}</span>
                            ${s.chapter_title ? `<span class="px-2 py-1 bg-green-100 text-green-700 rounded">${s.chapter_title}</span>` : ''}
                            <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded font-bold">${s.marks} mark(s)</span>
                        </div>
                    </div>
                    <div>
                        <button type="button" onclick="insertSavedQuestion(${idx})" 
                                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-all font-semibold">
                            <i class="fas fa-plus mr-1"></i> Insert
                        </button>
                    </div>
                </div>
            `).join('');

            // store last results on the DOM for insertion
            resultsDiv._last = questions;
        })
        .catch(err => {
            resultsDiv.innerHTML = '<div class="text-sm text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Error searching saved questions</div>';
            console.error(err);
        });
}

function insertSavedQuestion(idx) {
    const resultsDiv = document.getElementById('savedResults');
    const data = resultsDiv._last || [];
    const sel = data[idx];
    if (!sel) return;
    
    const question = {
        id: questionCounter++,
        number: questions.length + 1,
        text: sel.question,
        answer: sel.answer || '',
        marks: sel.marks || 1
    };
    
    questions.push(question);
    renderQuestions();
    updateTotalMarks();
    
    // Show success notification
    alert(`✅ Question added successfully! (${sel.marks} mark${sel.marks > 1 ? 's' : ''})`);
}
</script>
{% endblock %}
