{% extends 'base_new.html' %}

{% block title %}Upload Details - {{ upload.original_filename }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8 fade-in">
        <a href="{% url 'superadmin:upload_list' %}" class="text-blue-500 hover:text-blue-700 mb-2 inline-block">
            <i class="fas fa-arrow-left mr-2"></i>Back to List
        </a>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fas fa-file-pdf text-red-500 mr-2"></i>
            Upload Details
        </h1>
    </div>
    
    <!-- Main Card -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden fade-in">
        <!-- Status Banner -->
        <div class="p-6 {% if upload.status == 'done' %}bg-green-50 border-b-4 border-green-500{% elif upload.status == 'processing' %}bg-purple-50 border-b-4 border-purple-500{% elif upload.status == 'queued' %}bg-yellow-50 border-b-4 border-yellow-500{% else %}bg-red-50 border-b-4 border-red-500{% endif %}">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold {% if upload.status == 'done' %}text-green-800{% elif upload.status == 'processing' %}text-purple-800{% elif upload.status == 'queued' %}text-yellow-800{% else %}text-red-800{% endif %}">
                        {% if upload.status == 'done' %}
                            <i class="fas fa-check-circle mr-2"></i>Processing Completed
                        {% elif upload.status == 'processing' %}
                            <i class="fas fa-spinner fa-spin mr-2"></i>Currently Processing
                        {% elif upload.status == 'queued' %}
                            <i class="fas fa-clock mr-2"></i>Queued for Processing
                        {% else %}
                            <i class="fas fa-exclamation-triangle mr-2"></i>Processing Failed
                        {% endif %}
                    </h2>
                    <p class="text-sm {% if upload.status == 'done' %}text-green-600{% elif upload.status == 'processing' %}text-purple-600{% elif upload.status == 'queued' %}text-yellow-600{% else %}text-red-600{% endif %} mt-1">
                        {{ upload.notes|default:"No additional information" }}
                    </p>
                </div>
                {% if upload.status == 'processing' %}
                    <button onclick="checkStatus()" class="px-4 py-2 bg-white text-purple-600 rounded-lg border-2 border-purple-600 hover:bg-purple-50 transition">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh Status
                    </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Details Grid -->
        <div class="p-6">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- File Information -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                        <i class="fas fa-info-circle text-blue-500 mr-2"></i>File Information
                    </h3>
                    <dl class="space-y-3">
                        <div>
                            <dt class="text-sm font-semibold text-gray-500">Filename</dt>
                            <dd class="text-gray-800">{{ upload.original_filename }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-semibold text-gray-500">Upload ID</dt>
                            <dd class="text-gray-800 font-mono">{{ upload.id }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-semibold text-gray-500">File Path</dt>
                            <dd class="text-gray-800 text-sm break-all">{{ upload.file.name }}</dd>
                        </div>
                    </dl>
                </div>
                
                <!-- NCERT Mapping -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                        <i class="fas fa-book text-green-500 mr-2"></i>NCERT Mapping
                    </h3>
                    <dl class="space-y-3">
                        <div>
                            <dt class="text-sm font-semibold text-gray-500">Standard</dt>
                            <dd class="text-gray-800">
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full font-semibold">
                                    Standard {{ upload.standard }}
                                </span>
                            </dd>
                        </div>
                        <div>
                            <dt class="text-sm font-semibold text-gray-500">Subject</dt>
                            <dd class="text-gray-800 font-semibold">{{ upload.subject }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-semibold text-gray-500">Chapter</dt>
                            <dd class="text-gray-800 font-semibold">{{ upload.chapter }}</dd>
                        </div>
                    </dl>
                </div>
                
                <!-- Upload Details -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                        <i class="fas fa-clock text-purple-500 mr-2"></i>Upload Details
                    </h3>
                    <dl class="space-y-3">
                        <div>
                            <dt class="text-sm font-semibold text-gray-500">Uploaded By</dt>
                            <dd class="text-gray-800">{{ upload.uploader.username }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-semibold text-gray-500">Upload Time</dt>
                            <dd class="text-gray-800">{{ upload.uploaded_at|date:"F d, Y, H:i" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-semibold text-gray-500">Time Ago</dt>
                            <dd class="text-gray-800">{{ upload.uploaded_at|timesince }} ago</dd>
                        </div>
                    </dl>
                </div>
                
                <!-- Processing Details -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                        <i class="fas fa-cogs text-orange-500 mr-2"></i>Processing Details
                    </h3>
                    <dl class="space-y-3">
                        <div>
                            <dt class="text-sm font-semibold text-gray-500">Status</dt>
                            <dd class="text-gray-800 font-semibold capitalize">{{ upload.status }}</dd>
                        </div>
                        {% if upload.ingestion_job_id %}
                        <div>
                            <dt class="text-sm font-semibold text-gray-500">Job ID</dt>
                            <dd class="text-gray-800 font-mono text-sm">{{ upload.ingestion_job_id|truncatechars:30 }}</dd>
                        </div>
                        {% endif %}
                        <div>
                            <dt class="text-sm font-semibold text-gray-500">Notes</dt>
                            <dd class="text-gray-800 text-sm">{{ upload.notes|default:"No notes available" }}</dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

{% if upload.status == 'processing' %}
<script>
function checkStatus() {
    fetch('{% url "superadmin:upload_status" upload.id %}')
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'processing') {
                // Reload page if status changed
                location.reload();
            } else {
                alert('Still processing... Please check again later.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to check status');
        });
}

// Auto-refresh every 30 seconds
setInterval(() => {
    checkStatus();
}, 30000);
</script>
{% endif %}
{% endblock %}
