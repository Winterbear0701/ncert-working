{% extends 'base_new.html' %}
{% load static %}

{% block title %}Unit Test Analytics - {{ unit_test.title }}{% endblock %}

{% block extra_css %}
<style>
    .analytics-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1f2937;
        margin: 0.5rem 0;
    }
    
    .stat-label {
        color: #6b7280;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .stat-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .chart-container {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .question-analysis-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
        border-left: 4px solid #667eea;
    }
    
    .progress-bar-container {
        background: #e5e7eb;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }
    
    .progress-bar-fill {
        height: 100%;
        transition: width 0.3s;
        border-radius: 4px;
    }
    
    .score-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-weight: bold;
        font-size: 0.875rem;
    }
    
    .score-excellent {
        background: #dcfce7;
        color: #166534;
    }
    
    .score-good {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .score-average {
        background: #fef3c7;
        color: #92400e;
    }
    
    .score-poor {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .improvement-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: bold;
    }
    
    .improvement-positive {
        background: #dcfce7;
        color: #166534;
    }
    
    .improvement-negative {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .improvement-neutral {
        background: #f3f4f6;
        color: #4b5563;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="analytics-header">
        <h1 class="mb-2">
            <i class="fas fa-chart-line"></i>
            {{ unit_test.title }} - Analytics
        </h1>
        <p class="mb-0" style="opacity: 0.9;">Detailed performance analysis and insights</p>
    </div>

    {% if not attempts %}
    <!-- No Data -->
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="fas fa-chart-bar" style="font-size: 5rem; color: #9ca3af;"></i>
        </div>
        <h3>No Analytics Available</h3>
        <p class="text-muted mb-4">Take this unit test to see detailed analytics and performance insights.</p>
        <a href="{% url 'students:unit_test_start' unit_test.id %}" class="btn btn-primary btn-lg">
            <i class="fas fa-play-circle"></i>
            Start Unit Test
        </a>
    </div>
    {% else %}

    <!-- Stats Grid -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stat-card text-center">
                <div class="stat-icon" style="color: #3b82f6;">
                    <i class="fas fa-redo-alt"></i>
                </div>
                <div class="stat-value">{{ total_attempts }}</div>
                <div class="stat-label">Total Attempts</div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card text-center">
                <div class="stat-icon" style="color: #10b981;">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="stat-value">{{ best_score }}%</div>
                <div class="stat-label">Best Score</div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card text-center">
                <div class="stat-icon" style="color: #8b5cf6;">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="stat-value">{{ average_score }}%</div>
                <div class="stat-label">Average Score</div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card text-center">
                <div class="stat-icon" style="color: {% if improvement >= 0 %}#f59e0b{% else %}#ef4444{% endif %};">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-value">
                    {% if improvement >= 0 %}+{% endif %}{{ improvement }}%
                </div>
                <div class="stat-label">Improvement</div>
            </div>
        </div>
    </div>

    <!-- Performance Chart -->
    <div class="chart-container">
        <h4 class="mb-3">
            <i class="fas fa-chart-area"></i>
            Performance Trend
        </h4>
        <canvas id="performanceChart" height="80"></canvas>
    </div>

    <!-- Content vs Grammar Comparison -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="fas fa-file-alt"></i>
                    Content Quality
                </h5>
                <div class="text-center">
                    <div style="font-size: 3rem; font-weight: bold; color: #667eea;">
                        {{ avg_content }}%
                    </div>
                    <div class="progress-bar-container" style="height: 20px;">
                        <div class="progress-bar-fill" 
                             style="width: {{ avg_content }}%; background: linear-gradient(90deg, #667eea, #764ba2);"></div>
                    </div>
                    <p class="text-muted mt-2">Average content accuracy across all questions</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="fas fa-spell-check"></i>
                    Grammar Quality
                </h5>
                <div class="text-center">
                    <div style="font-size: 3rem; font-weight: bold; color: #10b981;">
                        {{ avg_grammar }}%
                    </div>
                    <div class="progress-bar-container" style="height: 20px;">
                        <div class="progress-bar-fill" 
                             style="width: {{ avg_grammar }}%; background: linear-gradient(90deg, #10b981, #059669);"></div>
                    </div>
                    <p class="text-muted mt-2">Average grammar and expression quality</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Question-wise Performance -->
    <div class="chart-container">
        <h4 class="mb-3">
            <i class="fas fa-clipboard-list"></i>
            Question-wise Performance (Best Attempt)
        </h4>
        
        {% for q in question_performance %}
        <div class="question-analysis-card">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <strong>Question {{ q.question_number }}</strong>
                    <span class="ms-2 text-muted">({{ q.marks }} marks)</span>
                </div>
                <div>
                    <span class="score-badge {% if q.percentage >= 80 %}score-excellent{% elif q.percentage >= 60 %}score-good{% elif q.percentage >= 40 %}score-average{% else %}score-poor{% endif %}">
                        {{ q.awarded_marks|floatformat:1 }}/{{ q.marks }} ({{ q.percentage }}%)
                    </span>
                </div>
            </div>
            
            <p class="text-muted mb-2">{{ q.question_text }}</p>
            
            <div class="row g-2 mb-2">
                <div class="col-md-6">
                    <small class="text-muted">Content Quality:</small>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" 
                             style="width: {{ q.content_score }}%; background: #667eea;"></div>
                    </div>
                    <small class="text-muted">{{ q.content_score|floatformat:0 }}%</small>
                </div>
                <div class="col-md-6">
                    <small class="text-muted">Grammar Quality:</small>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" 
                             style="width: {{ q.grammar_score }}%; background: #10b981;"></div>
                    </div>
                    <small class="text-muted">{{ q.grammar_score|floatformat:0 }}%</small>
                </div>
            </div>
            
            {% if q.feedback %}
            <div class="mt-2 p-2" style="background: #f9fafb; border-radius: 6px;">
                <small>
                    <i class="fas fa-robot text-primary"></i>
                    <strong>AI Feedback:</strong> {{ q.feedback }}
                </small>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Action Buttons -->
    <div class="text-center mt-4">
        <a href="{% url 'students:unit_test_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Back to Tests
        </a>
        <a href="{% url 'students:unit_test_results' best_attempt.id %}" class="btn btn-primary">
            <i class="fas fa-eye"></i>
            View Best Attempt
        </a>
        {% if unit_test.is_active %}
        <a href="{% url 'students:unit_test_start' unit_test.id %}" class="btn btn-success">
            <i class="fas fa-redo"></i>
            Retake Test
        </a>
        {% endif %}
    </div>

    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if attempts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Performance Trend Chart
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ attempt_labels|safe }},
            datasets: [{
                label: 'Score (%)',
                data: {{ percentages|safe }},
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 6,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            return 'Score: ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}
