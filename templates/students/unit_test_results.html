{% extends 'base_new.html' %}
{% load static %}

{% block title %}Test Results - {{ attempt.unit_test.title }}{% endblock %}

{% block extra_css %}
<style>
    .results-header {
        background: linear-gradient(135deg, {% if passed %}#10b981 0%, #059669 100%{% else %}#ef4444 0%, #dc2626 100%{% endif %});
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .result-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        border-top: 4px solid #667eea;
    }
    
    .stat-card.success {
        border-top-color: #10b981;
    }
    
    .stat-card.warning {
        border-top-color: #f59e0b;
    }
    
    .stat-card.danger {
        border-top-color: #ef4444;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #6b7280;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .answer-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }
    
    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .question-number {
        background: #667eea;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: bold;
    }
    
    .marks-badge {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    
    .marks-obtained {
        background: #10b981;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: bold;
    }
    
    .marks-total {
        background: #6b7280;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: bold;
    }
    
    .question-text {
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 1rem;
        color: #1f2937;
        font-weight: 500;
    }
    
    .answer-section {
        background: #f9fafb;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .answer-label {
        font-weight: bold;
        color: #374151;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .answer-text {
        color: #1f2937;
        line-height: 1.6;
        white-space: pre-wrap;
    }
    
    .feedback-section {
        background: #eff6ff;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
    }
    
    .feedback-label {
        font-weight: bold;
        color: #1e40af;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .feedback-text {
        color: #1e3a8a;
        line-height: 1.6;
    }
    
    .score-breakdown {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }
    
    .score-item {
        background: white;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
    }
    
    .score-item strong {
        color: #1f2937;
    }
    
    .score-item span {
        color: #6b7280;
        font-size: 0.875rem;
    }
    
    .overall-feedback {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        border-left: 4px solid #8b5cf6;
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 2rem;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        color: white;
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
        padding: 1rem 2rem;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
        color: white;
    }
    
    .no-answer {
        color: #9ca3af;
        font-style: italic;
    }
    
    .progress-circle {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: conic-gradient(
            {% if passed %}#10b981{% else %}#ef4444{% endif %} 0% {{ percentage }}%,
            #e5e7eb {{ percentage }}% 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
    }
    
    .progress-inner {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    
    .progress-percentage {
        font-size: 2.5rem;
        font-weight: bold;
        color: {% if passed %}#10b981{% else %}#ef4444{% endif %};
    }
    
    .progress-label {
        font-size: 0.875rem;
        color: #6b7280;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Results Header -->
    <div class="results-header text-center">
        <div class="result-icon">
            {% if passed %}
                <i class="fas fa-check-circle"></i>
            {% else %}
                <i class="fas fa-times-circle"></i>
            {% endif %}
        </div>
        <h1 class="mb-2">
            {% if passed %}
                ðŸŽ‰ Congratulations! You Passed!
            {% else %}
                Keep Trying! You Can Do Better!
            {% endif %}
        </h1>
        <h3 class="mb-0">{{ attempt.unit_test.title }}</h3>
        <p class="mt-2 mb-0" style="opacity: 0.9;">
            Submitted on {{ attempt.submitted_at|date:"F d, Y g:i A" }}
        </p>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="progress-circle">
                <div class="progress-inner">
                    <div class="progress-percentage">{{ percentage }}%</div>
                    <div class="progress-label">Score</div>
                </div>
            </div>
        </div>
        
        <div class="stat-card {% if passed %}success{% else %}danger{% endif %}">
            <div class="stat-value">
                {{ attempt.total_marks_obtained|floatformat:1 }} / {{ attempt.unit_test.total_marks }}
            </div>
            <div class="stat-label">
                <i class="fas fa-star"></i>
                Marks Obtained
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-value">{{ attempt.time_taken_seconds|floatformat:0 }}s</div>
            <div class="stat-label">
                <i class="fas fa-clock"></i>
                Time Taken
            </div>
        </div>
        
        <div class="stat-card {% if passed %}success{% else %}warning{% endif %}">
            <div class="stat-value">
                {% if passed %}
                    <i class="fas fa-check-circle" style="color: #10b981;"></i> PASS
                {% else %}
                    <i class="fas fa-times-circle" style="color: #ef4444;"></i> FAIL
                {% endif %}
            </div>
            <div class="stat-label">
                Status (Passing: {{ attempt.unit_test.passing_percentage }}%)
            </div>
        </div>
    </div>

    <!-- Overall Feedback -->
    {% if attempt.overall_feedback %}
    <div class="overall-feedback">
        <h4>
            <i class="fas fa-comments"></i>
            Overall Feedback
        </h4>
        <p class="mb-0">{{ attempt.overall_feedback }}</p>
    </div>
    {% endif %}

    <!-- Detailed Answers -->
    <div class="mb-4">
        <h3 class="mb-3">
            <i class="fas fa-clipboard-check"></i>
            Detailed Answer Review
        </h3>
        
        {% for answer in answers %}
        <div class="answer-card">
            <div class="question-header">
                <span class="question-number">
                    Question {{ answer.question.question_number }}
                </span>
                <div class="marks-badge">
                    <span class="marks-obtained">
                        <i class="fas fa-award"></i>
                        {{ answer.awarded_marks|floatformat:1 }} Marks
                    </span>
                    <span class="marks-total">
                        Out of {{ answer.question.marks }}
                    </span>
                </div>
            </div>
            
            <div class="question-text">
                <i class="fas fa-question-circle"></i>
                {{ answer.question.question_text|linebreaks }}
            </div>
            
            <div class="answer-section">
                <div class="answer-label">
                    <i class="fas fa-pen"></i>
                    Your Answer:
                </div>
                <div class="answer-text">
                    {% if answer.answer_text %}
                        {{ answer.answer_text|linebreaks }}
                    {% else %}
                        <span class="no-answer">No answer provided</span>
                    {% endif %}
                </div>
            </div>
            
            {% if answer.ai_feedback %}
            <div class="feedback-section">
                <div class="feedback-label">
                    <i class="fas fa-robot"></i>
                    AI Evaluation Feedback:
                </div>
                <div class="feedback-text">
                    {{ answer.ai_feedback|linebreaks }}
                </div>
                
                <div class="score-breakdown">
                    {% if answer.content_score is not None %}
                    <div class="score-item">
                        <strong>Content Score:</strong>
                        <span>{{ answer.content_score|floatformat:1 }}/10</span>
                    </div>
                    {% endif %}
                    
                    {% if answer.grammar_score is not None %}
                    <div class="score-item">
                        <strong>Grammar Score:</strong>
                        <span>{{ answer.grammar_score|floatformat:1 }}/10</span>
                    </div>
                    {% endif %}
                    
                    <div class="score-item">
                        <strong>Evaluation Type:</strong>
                        <span>{{ answer.evaluation_type|upper }}</span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="feedback-section">
                <div class="feedback-label">
                    <i class="fas fa-info-circle"></i>
                    Status:
                </div>
                <div class="feedback-text">
                    {% if answer.answer_text %}
                        Evaluation in progress. Please check back later.
                    {% else %}
                        No answer submitted - 0 marks awarded.
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            No answers found for this test attempt.
        </div>
        {% endfor %}
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{% url 'students:unit_test_list' %}" class="btn-secondary">
            <i class="fas fa-list"></i>
            Back to Tests
        </a>
        <a href="{% url 'students:student_dashboard' %}" class="btn-primary">
            <i class="fas fa-home"></i>
            Go to Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Print results functionality
    function printResults() {
        window.print();
    }
    
    // Add print button if needed
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Test results loaded successfully');
        console.log('Score: {{ percentage }}%');
        console.log('Status: {% if passed %}PASSED{% else %}FAILED{% endif %}');
    });
</script>
{% endblock %}
