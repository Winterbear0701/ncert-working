{% extends 'base_new.html' %}

{% block title %}Smart Test Analysis - NCERT Learning{% endblock %}

{% block content %}
<!-- Modern Elegant Smart Analysis Dashboard -->
<div class="min-h-screen">
    
    <!-- Elegant Hero Header -->
    <div class="relative overflow-hidden bg-gradient-to-r from-slate-900 via-blue-900 to-indigo-900 text-white mb-8">
        <!-- Subtle Pattern Overlay -->
        <div class="absolute inset-0 opacity-5">
            <svg width="100%" height="100%">
                <defs>
                    <pattern id="analysis-pattern" x="0" y="0" width="80" height="80" patternUnits="userSpaceOnUse">
                        <circle cx="40" cy="40" r="25" fill="none" stroke="currentColor" stroke-width="0.5"/>
                        <path d="M40 15 L40 65 M15 40 L65 40" stroke="currentColor" stroke-width="0.5"/>
                        <circle cx="40" cy="40" r="3" fill="currentColor"/>
                    </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#analysis-pattern)"/>
            </svg>
        </div>
        
        <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex items-center justify-between">
                <div class="space-y-2 fade-in">
                    <div class="flex items-center space-x-3">
                        <div class="w-14 h-14 bg-gradient-to-br from-blue-400 to-indigo-600 rounded-2xl flex items-center justify-center shadow-xl">
                            <i class="fas fa-brain text-2xl text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl md:text-4xl font-bold">Smart Test Analysis</h1>
                            <p class="text-blue-200 text-sm md:text-base">AI-powered probability-based analysis of your test performance</p>
                        </div>
                    </div>
                </div>
                
                <!-- Floating Analytics Icon -->
                <div class="hidden md:block animate-float">
                    <i class="fas fa-chart-line text-6xl text-blue-300 opacity-50"></i>
                </div>
            </div>
        </div>
        
        <!-- Wave Divider -->
        <div class="relative">
            <svg class="w-full h-12" viewBox="0 0 1200 120" preserveAspectRatio="none">
                <path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" fill="rgb(248 250 252)"></path>
            </svg>
        </div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        {% if error %}
            <!-- Error State -->
            <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
                <div class="inline-block p-6 bg-red-50 rounded-full mb-6">
                    <i class="fas fa-exclamation-triangle text-5xl text-red-500"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">Analysis Error</h3>
                <p class="text-slate-600 mb-6">{{ error }}</p>
                <a href="{% url 'students:student_dashboard' %}" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Dashboard
                </a>
            </div>
        
        {% elif not analysis %}
            <!-- No Data State -->
            <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
                <div class="inline-block p-6 bg-slate-50 rounded-full mb-6">
                    <i class="fas fa-clipboard-list text-5xl text-slate-300"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">No Test Data Available</h3>
                <p class="text-slate-600 mb-6">Take some quizzes or unit tests first to see your smart analysis</p>
                <div class="flex items-center justify-center space-x-4">
                    <a href="{% url 'students:quiz_dashboard' %}" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-orange-600 to-red-600 text-white font-semibold rounded-xl hover:from-orange-700 hover:to-red-700 transition-all shadow-lg">
                        <i class="fas fa-clipboard-check mr-2"></i>
                        Take Quiz
                    </a>
                    <a href="{% url 'students:unit_test_list' %}" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-emerald-600 to-green-600 text-white font-semibold rounded-xl hover:from-emerald-700 hover:to-green-700 transition-all shadow-lg">
                        <i class="fas fa-file-alt mr-2"></i>
                        Take Unit Test
                    </a>
                </div>
            </div>
        
        {% else %}
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Attempts -->
                <div class="bg-white rounded-2xl shadow-lg p-6 fade-in transform hover:scale-105 transition-all duration-300">
                    <div class="flex items-center justify-between mb-2">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-list-check text-xl text-white"></i>
                        </div>
                        <span class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                            {{ analysis.summary.total_quiz_attempts|add:analysis.summary.total_unit_test_attempts }}
                        </span>
                    </div>
                    <p class="text-slate-600 text-sm font-semibold">Total Attempts</p>
                    <p class="text-xs text-slate-500 mt-1">{{ analysis.summary.total_quiz_attempts }} quizzes + {{ analysis.summary.total_unit_test_attempts }} tests</p>
                </div>
                
                <!-- Chapters Covered -->
                <div class="bg-white rounded-2xl shadow-lg p-6 fade-in transform hover:scale-105 transition-all duration-300" style="animation-delay: 0.1s">
                    <div class="flex items-center justify-between mb-2">
                        <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-book text-xl text-white"></i>
                        </div>
                        <span class="text-3xl font-bold bg-gradient-to-r from-emerald-600 to-green-600 bg-clip-text text-transparent">
                            {{ analysis.summary.total_chapters_attempted }}
                        </span>
                    </div>
                    <p class="text-slate-600 text-sm font-semibold">Chapters Covered</p>
                    <p class="text-xs text-slate-500 mt-1">Across all subjects</p>
                </div>
                
                <!-- Quiz Average -->
                <div class="bg-white rounded-2xl shadow-lg p-6 fade-in transform hover:scale-105 transition-all duration-300" style="animation-delay: 0.2s">
                    <div class="flex items-center justify-between mb-2">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-clipboard-check text-xl text-white"></i>
                        </div>
                        <span class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                            {{ analysis.summary.overall_quiz_avg|floatformat:0 }}%
                        </span>
                    </div>
                    <p class="text-slate-600 text-sm font-semibold">Quiz Average</p>
                    <div class="w-full bg-slate-100 rounded-full h-2 mt-2">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-600 h-2 rounded-full" style="width: {{ analysis.summary.overall_quiz_avg }}%"></div>
                    </div>
                </div>
                
                <!-- Topics Covered -->
                <div class="bg-white rounded-2xl shadow-lg p-6 fade-in transform hover:scale-105 transition-all duration-300" style="animation-delay: 0.3s">
                    <div class="flex items-center justify-between mb-2">
                        <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-tags text-xl text-white"></i>
                        </div>
                        <span class="text-3xl font-bold bg-gradient-to-r from-amber-600 to-orange-600 bg-clip-text text-transparent">
                            {{ analysis.summary.total_topics_covered }}
                        </span>
                    </div>
                    <p class="text-slate-600 text-sm font-semibold">Topics Covered</p>
                    <p class="text-xs text-slate-500 mt-1">Unique topics attempted</p>
                </div>
            </div>
            
            <!-- Performance Trend -->
            {% if analysis.performance_trend.trend != 'insufficient_data' %}
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-slate-900 flex items-center">
                        <i class="fas fa-chart-line mr-3 text-blue-600"></i>
                        Performance Trend
                    </h2>
                    <span class="px-4 py-2 rounded-full text-sm font-semibold
                        {% if analysis.performance_trend.trend == 'improving' %}bg-green-100 text-green-800
                        {% elif analysis.performance_trend.trend == 'declining' %}bg-red-100 text-red-800
                        {% else %}bg-slate-100 text-slate-800{% endif %}">
                        {% if analysis.performance_trend.trend == 'improving' %}
                            <i class="fas fa-arrow-up mr-1"></i>Improving
                        {% elif analysis.performance_trend.trend == 'declining' %}
                            <i class="fas fa-arrow-down mr-1"></i>Declining
                        {% else %}
                            <i class="fas fa-minus mr-1"></i>Stable
                        {% endif %}
                    </span>
                </div>
                <p class="text-slate-600 mb-4">{{ analysis.performance_trend.message }}</p>
                
                <!-- Trend visualization -->
                <div class="flex items-end space-x-2 h-32">
                    {% for score in analysis.performance_trend.recent_scores %}
                    <div class="flex-1 bg-gradient-to-t from-blue-500 to-indigo-600 rounded-t-lg relative group hover:opacity-80 transition-opacity" 
                         style="height: {{ score }}%;">
                        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                            {{ score|floatformat:0 }}%
                        </span>
                    </div>
                    {% endfor %}
                </div>
                <div class="flex justify-between text-xs text-slate-500 mt-2">
                    <span>Older</span>
                    <span>Recent</span>
                </div>
            </div>
            {% endif %}
            
            <!-- Chapter Importance Analysis -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-8 fade-in">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <i class="fas fa-book-open mr-3"></i>
                        Chapter Importance Analysis
                    </h2>
                    <p class="text-indigo-100 text-sm mt-1">Chapters ranked by importance based on performance and frequency</p>
                </div>
                
                <div class="p-6">
                    {% if analysis.chapter_analysis %}
                        <div class="space-y-4">
                            {% for chapter in analysis.chapter_analysis|slice:":10" %}
                            <div class="border border-slate-200 rounded-xl p-4 hover:shadow-md transition-shadow">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3 mb-2">
                                            <span class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-lg flex items-center justify-center text-sm font-bold">
                                                {{ forloop.counter }}
                                            </span>
                                            <div>
                                                <h3 class="font-bold text-slate-900">{{ chapter.chapter_name }}</h3>
                                                <p class="text-sm text-slate-600">{{ chapter.subject }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Priority Badge -->
                                    <span class="px-3 py-1 rounded-full text-xs font-bold
                                        {% if chapter.priority == 'Critical' %}bg-red-100 text-red-800
                                        {% elif chapter.priority == 'High' %}bg-orange-100 text-orange-800
                                        {% elif chapter.priority == 'Medium' %}bg-yellow-100 text-yellow-800
                                        {% else %}bg-green-100 text-green-800{% endif %}">
                                        {{ chapter.priority }}
                                    </span>
                                </div>
                                
                                <!-- Metrics Grid -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-3">
                                    <div>
                                        <p class="text-xs text-slate-500 uppercase">Importance</p>
                                        <p class="text-lg font-bold text-slate-900">{{ chapter.importance_score|floatformat:0 }}/100</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500 uppercase">Quiz Avg</p>
                                        <p class="text-lg font-bold 
                                            {% if chapter.quiz_avg >= 70 %}text-green-600
                                            {% elif chapter.quiz_avg >= 50 %}text-yellow-600
                                            {% else %}text-red-600{% endif %}">
                                            {{ chapter.quiz_avg|floatformat:0 }}%
                                        </p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500 uppercase">Attempts</p>
                                        <p class="text-lg font-bold text-slate-900">{{ chapter.quiz_attempts|add:chapter.unit_test_attempts }}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500 uppercase">Trend</p>
                                        <p class="text-sm font-semibold 
                                            {% if chapter.trend == 'improving' %}text-green-600
                                            {% elif chapter.trend == 'declining' %}text-red-600
                                            {% else %}text-slate-600{% endif %}">
                                            {% if chapter.trend == 'improving' %}<i class="fas fa-arrow-up"></i> Improving
                                            {% elif chapter.trend == 'declining' %}<i class="fas fa-arrow-down"></i> Declining
                                            {% else %}<i class="fas fa-minus"></i> Stable{% endif %}
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- Importance Bar -->
                                <div class="w-full bg-slate-100 rounded-full h-2">
                                    <div class="h-2 rounded-full {% if chapter.priority == 'Critical' %}bg-gradient-to-r from-red-500 to-rose-600
                                        {% elif chapter.priority == 'High' %}bg-gradient-to-r from-orange-500 to-amber-600
                                        {% elif chapter.priority == 'Medium' %}bg-gradient-to-r from-yellow-500 to-amber-600
                                        {% else %}bg-gradient-to-r from-green-500 to-emerald-600{% endif %}" 
                                        style="width: {{ chapter.importance_score }}%"></div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center text-slate-500 py-8">No chapter data available yet</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Weak Areas & Study Recommendations -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Weak Chapters -->
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden fade-in">
                    <div class="bg-gradient-to-r from-rose-600 to-red-600 px-6 py-4">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-exclamation-triangle mr-3"></i>
                            Weak Chapters
                        </h2>
                    </div>
                    <div class="p-6">
                        {% if analysis.weak_areas.chapters %}
                            <div class="space-y-3">
                                {% for weak in analysis.weak_areas.chapters|slice:":5" %}
                                <div class="border-l-4 border-red-500 pl-4 py-2 hover:bg-red-50 transition-colors">
                                    <h4 class="font-semibold text-slate-900">{{ weak.chapter_name }}</h4>
                                    <p class="text-sm text-slate-600">{{ weak.subject }}</p>
                                    <p class="text-xs text-red-600 mt-1"><i class="fas fa-info-circle mr-1"></i>{{ weak.reason }}</p>
                                    <p class="text-xs text-slate-700 mt-1"><strong>Action:</strong> {{ weak.recommended_action }}</p>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-center text-slate-500 py-4">Great! No weak chapters identified</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Study Recommendations -->
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden fade-in">
                    <div class="bg-gradient-to-r from-emerald-600 to-green-600 px-6 py-4">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-lightbulb mr-3"></i>
                            Study Recommendations
                        </h2>
                    </div>
                    <div class="p-6">
                        {% if analysis.study_recommendations %}
                            <div class="space-y-3">
                                {% for rec in analysis.study_recommendations|slice:":5" %}
                                <div class="border border-emerald-200 rounded-lg p-3 hover:shadow-md transition-shadow">
                                    {% if rec.type == 'chapter' %}
                                        <div class="flex items-start justify-between mb-2">
                                            <h4 class="font-semibold text-slate-900">{{ rec.chapter_name }}</h4>
                                            <span class="px-2 py-1 rounded text-xs font-bold {% if rec.priority == 'Critical' %}bg-red-100 text-red-800{% else %}bg-orange-100 text-orange-800{% endif %}">
                                                {{ rec.priority }}
                                            </span>
                                        </div>
                                        <p class="text-sm text-slate-600 mb-2">{{ rec.reason }}</p>
                                        <div class="flex items-center text-xs text-slate-500">
                                            <i class="far fa-clock mr-1"></i>
                                            Recommended: {{ rec.study_time_minutes }} minutes
                                        </div>
                                        {% if rec.focus_areas %}
                                        <div class="mt-2 flex flex-wrap gap-1">
                                            {% for topic in rec.focus_areas %}
                                            <span class="px-2 py-0.5 bg-slate-100 text-slate-700 rounded text-xs">{{ topic }}</span>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="flex items-start justify-between mb-2">
                                            <h4 class="font-semibold text-slate-900"><i class="fas fa-tag mr-1 text-emerald-600"></i>{{ rec.topic }}</h4>
                                            <span class="px-2 py-1 rounded text-xs font-bold bg-emerald-100 text-emerald-800">
                                                {{ rec.chapters_affected }} chapters
                                            </span>
                                        </div>
                                        <p class="text-sm text-slate-600">{{ rec.reason }}</p>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-center text-slate-500 py-4">Keep up the great work! Continue practicing regularly.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Topic Importance (Expandable) -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden fade-in mb-8">
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 px-6 py-4">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <i class="fas fa-tags mr-3"></i>
                        Topic Analysis
                    </h2>
                    <p class="text-purple-100 text-sm mt-1">Topics ranked by importance and accuracy</p>
                </div>
                
                <div class="p-6">
                    {% if analysis.topic_analysis %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for topic in analysis.topic_analysis|slice:":12" %}
                            <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex items-start justify-between mb-2">
                                    <h4 class="font-semibold text-slate-900 flex-1">{{ topic.topic }}</h4>
                                    <span class="px-2 py-1 rounded text-xs font-bold flex-shrink-0 ml-2
                                        {% if topic.priority == 'Critical' %}bg-red-100 text-red-800
                                        {% elif topic.priority == 'High' %}bg-orange-100 text-orange-800
                                        {% else %}bg-slate-100 text-slate-800{% endif %}">
                                        {{ topic.priority }}
                                    </span>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <p class="text-xs text-slate-500">Quiz Accuracy</p>
                                        <p class="font-bold {% if topic.quiz_accuracy >= 70 %}text-green-600{% elif topic.quiz_accuracy >= 50 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                            {{ topic.quiz_accuracy|floatformat:0 }}%
                                        </p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500">Attempts</p>
                                        <p class="font-bold text-slate-900">{{ topic.quiz_attempts|add:topic.unit_test_attempts }}</p>
                                    </div>
                                </div>
                                
                                <div class="mt-2 w-full bg-slate-100 rounded-full h-1.5">
                                    <div class="bg-gradient-to-r from-purple-500 to-pink-600 h-1.5 rounded-full" style="width: {{ topic.importance_score }}%"></div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center text-slate-500 py-8">No topic data available yet</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex items-center justify-center space-x-4 mb-8">
                <a href="{% url 'students:quiz_dashboard' %}" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-orange-600 to-red-600 text-white font-semibold rounded-xl hover:from-orange-700 hover:to-red-700 transition-all shadow-lg transform hover:scale-105">
                    <i class="fas fa-clipboard-check mr-2"></i>
                    Practice Quiz
                </a>
                <a href="{% url 'students:unit_test_list' %}" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-emerald-600 to-green-600 text-white font-semibold rounded-xl hover:from-emerald-700 hover:to-green-700 transition-all shadow-lg transform hover:scale-105">
                    <i class="fas fa-file-alt mr-2"></i>
                    Take Unit Test
                </a>
                <a href="{% url 'students:student_dashboard' %}" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-slate-600 to-slate-700 text-white font-semibold rounded-xl hover:from-slate-700 hover:to-slate-800 transition-all shadow-lg transform hover:scale-105">
                    <i class="fas fa-home mr-2"></i>
                    Dashboard
                </a>
            </div>
            
        {% endif %}
    </div>
</div>
{% endblock %}
