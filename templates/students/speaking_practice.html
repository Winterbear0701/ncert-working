{% extends 'base_new.html' %}

{% block title %}AI Speaking Practice - NCERT Learning{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" x-data="speakingPractice()" x-init="init()">
    
    <!-- Session Setup (Before Starting) -->
    <div x-show="!sessionActive && !showAnalytics" class="fade-in">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-microphone-alt text-purple-500 mr-2"></i>
                AI Speaking Practice Room
            </h1>
            <p class="text-gray-600">Practice English speaking with AI tutor and get instant feedback</p>
        </div>
        
        <!-- Practice Type Selection -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Choose Practice Type</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Free Conversation -->
                <button @click="practiceType = 'free'" 
                        :class="practiceType === 'free' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'"
                        class="border-2 rounded-lg p-4 text-left transition hover:border-purple-300">
                    <div class="text-3xl mb-2">ðŸ’¬</div>
                    <h3 class="font-semibold text-gray-800">Free Conversation</h3>
                    <p class="text-sm text-gray-600 mt-1">Natural conversation on any topic</p>
                </button>
                
                <!-- Topic Discussion -->
                <button @click="practiceType = 'topic'" 
                        :class="practiceType === 'topic' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'"
                        class="border-2 rounded-lg p-4 text-left transition hover:border-purple-300">
                    <div class="text-3xl mb-2">ðŸ“š</div>
                    <h3 class="font-semibold text-gray-800">Topic Discussion</h3>
                    <p class="text-sm text-gray-600 mt-1">Discuss educational topics</p>
                </button>
                
                <!-- Presentation -->
                <button @click="practiceType = 'presentation'" 
                        :class="practiceType === 'presentation' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'"
                        class="border-2 rounded-lg p-4 text-left transition hover:border-purple-300">
                    <div class="text-3xl mb-2">ðŸ“Š</div>
                    <h3 class="font-semibold text-gray-800">Presentation</h3>
                    <p class="text-sm text-gray-600 mt-1">Practice presenting ideas</p>
                </button>
                
                <!-- Interview -->
                <button @click="practiceType = 'interview'" 
                        :class="practiceType === 'interview' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'"
                        class="border-2 rounded-lg p-4 text-left transition hover:border-purple-300">
                    <div class="text-3xl mb-2">ðŸŽ¤</div>
                    <h3 class="font-semibold text-gray-800">Interview</h3>
                    <p class="text-sm text-gray-600 mt-1">Simulate interview scenarios</p>
                </button>
            </div>
        </div>
        
        <!-- Start Button -->
        <div class="text-center">
            <button @click="startSession()" 
                    class="px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-lg font-semibold rounded-lg shadow-lg hover:from-purple-600 hover:to-pink-600 transition transform hover:scale-105">
                <i class="fas fa-play mr-2"></i>
                Start Speaking Practice
            </button>
            <p class="text-sm text-gray-600 mt-2">Make sure your microphone is working</p>
        </div>
        
        <!-- Previous Sessions -->
        {% if previous_sessions %}
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-history mr-2"></i>Previous Sessions
            </h2>
            <div class="space-y-3">
                {% for session in previous_sessions %}
                <a href="{% url 'students:speaking_practice_detail' session.id %}" 
                   class="block p-4 border border-gray-200 rounded-lg hover:border-purple-300 hover:bg-purple-50 transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-semibold text-gray-800">{{ session.get_practice_type_display }}</span>
                            <span class="text-sm text-gray-500 ml-2">{{ session.created_at|date:"M d, Y - H:i" }}</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-2xl font-bold" 
                                  :class="{{session.overall_score}} >= 80 ? 'text-green-600' : {{session.overall_score}} >= 60 ? 'text-yellow-600' : 'text-red-600'">
                                {{ session.overall_score }}/100
                            </span>
                            <span class="text-sm text-gray-500">{{ session.get_duration_display }}</span>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
            <div class="text-center mt-4">
                <a href="{% url 'students:speaking_practice_history' %}" 
                   class="text-purple-600 hover:text-purple-700 font-semibold">
                    View All Sessions â†’
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Speaking Room (During Session) -->
    <div x-show="sessionActive" x-cloak class="fade-in">
        <!-- Header with Stats -->
        <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg shadow-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-microphone-alt mr-2"></i>
                        Speaking Practice Session
                    </h2>
                    <p class="text-purple-100" x-text="getPracticeTypeLabel()"></p>
                </div>
                <div class="flex items-center space-x-6 text-right">
                    <div>
                        <div class="text-3xl font-bold" x-text="formatTime(duration)"></div>
                        <div class="text-sm text-purple-100">Duration</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold" x-text="exchangeCount"></div>
                        <div class="text-sm text-purple-100">Exchanges</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold" x-text="wordCount"></div>
                        <div class="text-sm text-purple-100">Words</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Room Area -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- AI Tutor Section -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="text-center">
                    <div class="w-32 h-32 mx-auto mb-4 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                        <i class="fas fa-robot text-white text-5xl"></i>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">ðŸ¤– AI Tutor</h3>
                    
                    <!-- Sound Wave Animation when AI is speaking -->
                    <div x-show="isSpeaking" class="mb-4">
                        <div class="flex items-center justify-center space-x-1 h-16">
                            <div class="w-1 bg-blue-500 rounded-full speaking-wave" style="animation-delay: 0s;"></div>
                            <div class="w-1 bg-blue-500 rounded-full speaking-wave" style="animation-delay: 0.1s;"></div>
                            <div class="w-1 bg-blue-500 rounded-full speaking-wave" style="animation-delay: 0.2s;"></div>
                            <div class="w-1 bg-blue-500 rounded-full speaking-wave" style="animation-delay: 0.3s;"></div>
                            <div class="w-1 bg-blue-500 rounded-full speaking-wave" style="animation-delay: 0.4s;"></div>
                        </div>
                        <p class="text-blue-600 font-semibold">AI is speaking...</p>
                    </div>
                    
                    <!-- AI Status -->
                    <div x-show="!isSpeaking" class="mb-4">
                        <div class="flex items-center justify-center space-x-2 text-gray-500">
                            <div class="w-3 h-3 rounded-full bg-blue-500" :class="currentTurn === 'student' ? 'animate-pulse' : ''"></div>
                            <span x-text="currentTurn === 'student' ? 'Listening to you...' : 'AI is thinking...'"></span>
                        </div>
                    </div>
                    
                    <!-- AI Transcript -->
                    <div class="bg-blue-50 rounded-lg p-4 min-h-[120px] text-left">
                        <p class="text-gray-800" x-text="aiTranscript || 'Waiting for AI...'"></p>
                    </div>
                </div>
            </div>
            
            <!-- Student Section -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="text-center">
                    <div class="w-32 h-32 mx-auto mb-4 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center">
                        <i class="fas fa-user text-white text-5xl"></i>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">ðŸ‘¤ You</h3>
                    
                    <!-- Sound Wave Animation when student is speaking -->
                    <div x-show="isListening" class="mb-4">
                        <div class="flex items-center justify-center space-x-1 h-16">
                            <div class="w-1 bg-red-500 rounded-full listening-wave" style="animation-delay: 0s;"></div>
                            <div class="w-1 bg-red-500 rounded-full listening-wave" style="animation-delay: 0.1s;"></div>
                            <div class="w-1 bg-red-500 rounded-full listening-wave" style="animation-delay: 0.2s;"></div>
                            <div class="w-1 bg-red-500 rounded-full listening-wave" style="animation-delay: 0.3s;"></div>
                            <div class="w-1 bg-red-500 rounded-full listening-wave" style="animation-delay: 0.4s;"></div>
                        </div>
                        <p class="text-red-600 font-semibold">ðŸŽ¤ Speaking...</p>
                    </div>
                    
                    <!-- Student Status -->
                    <div x-show="!isListening" class="mb-4">
                        <div class="flex items-center justify-center space-x-2 text-gray-500">
                            <div class="w-3 h-3 rounded-full" 
                                 :class="micOn ? 'bg-green-500 animate-pulse' : 'bg-gray-300'"></div>
                            <span x-text="micOn ? (currentTurn === 'student' ? 'Ready to speak' : 'Waiting for AI...') : 'Mic is OFF'"></span>
                        </div>
                    </div>
                    
                    <!-- Student Transcript -->
                    <div class="bg-purple-50 rounded-lg p-4 min-h-[120px] text-left">
                        <p class="text-gray-800" x-text="studentTranscript || (interimTranscript ? interimTranscript + '...' : 'Click mic to speak')"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex items-center justify-center space-x-4">
                <!-- Microphone Toggle -->
                <button @click="toggleMic()" 
                        :class="micOn ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'"
                        class="px-8 py-4 text-white rounded-full shadow-lg transition transform hover:scale-105">
                    <i class="fas" :class="micOn ? 'fa-microphone' : 'fa-microphone-slash'" class="text-2xl"></i>
                </button>
                
                <!-- Speak Button (when mic is on) -->
                <button x-show="micOn && currentTurn === 'student' && !isListening" 
                        @click="startSpeaking()" 
                        class="px-12 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-lg font-semibold rounded-full shadow-lg hover:from-purple-600 hover:to-pink-600 transition transform hover:scale-105">
                    <i class="fas fa-microphone-alt mr-2"></i>
                    Tap to Speak
                </button>
                
                <!-- Stop Speaking Button -->
                <button x-show="isListening" 
                        @click="stopSpeaking()" 
                        class="px-12 py-4 bg-red-500 text-white text-lg font-semibold rounded-full shadow-lg hover:bg-red-600 transition animate-pulse">
                    <i class="fas fa-stop mr-2"></i>
                    Stop Speaking
                </button>
                
                <!-- End Session -->
                <button @click="confirmEndSession()" 
                        class="px-8 py-4 bg-gray-600 text-white rounded-full shadow-lg hover:bg-gray-700 transition">
                    <i class="fas fa-times-circle text-2xl"></i>
                </button>
            </div>
            
            <div class="text-center mt-4 text-sm text-gray-600">
                <template x-if="!micOn">
                    <p>Turn on your microphone to start speaking</p>
                </template>
                <template x-if="micOn && currentTurn === 'student' && !isListening">
                    <p>Click "Tap to Speak" and respond to the AI</p>
                </template>
                <template x-if="isListening">
                    <p>Speak clearly... Click "Stop Speaking" when done</p>
                </template>
                <template x-if="currentTurn === 'ai'">
                    <p>AI is preparing response...</p>
                </template>
            </div>
        </div>
    </div>
    
    <!-- Analytics (After Session) -->
    <div x-show="showAnalytics" x-cloak class="fade-in">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-chart-line text-green-500 mr-2"></i>
                Speaking Practice Report
            </h1>
            <p class="text-gray-600">Detailed analysis of your performance</p>
        </div>
        
        <template x-if="analysisData">
            <!-- Overall Score -->
            <div class="bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg shadow-lg p-6 mb-6">
                <div class="text-center">
                    <div class="text-6xl font-bold mb-2" x-text="analysisData.overall_score + '/100'"></div>
                    <div class="text-xl">Overall Score</div>
                    <div class="mt-4 flex items-center justify-center space-x-2">
                        <template x-for="i in 5">
                            <i class="fas fa-star text-yellow-300 text-2xl" 
                               x-show="i <= Math.round(analysisData.overall_score / 20)"></i>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- Continue with detailed analytics... -->
            <!-- This is getting long - I'll create a separate template file for analytics -->
            
            <div class="text-center mt-6 space-x-4">
                <button @click="resetSession()" 
                        class="px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-lg shadow-lg hover:from-purple-600 hover:to-pink-600 transition">
                    <i class="fas fa-redo mr-2"></i>
                    Start New Session
                </button>
                <a href="{% url 'students:speaking_practice_history' %}" 
                   class="inline-block px-8 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-lg hover:bg-gray-700 transition">
                    <i class="fas fa-history mr-2"></i>
                    View History
                </a>
            </div>
        </template>
    </div>
</div>

{% csrf_token %}
{% endblock %}

{% block extra_css %}
<style>
[x-cloak] { display: none !important; }

/* Speaking wave animation */
@keyframes speaking-wave {
    0%, 100% { height: 0.5rem; }
    50% { height: 3rem; }
}

.speaking-wave {
    animation: speaking-wave 1s ease-in-out infinite;
}

/* Listening wave animation */
@keyframes listening-wave {
    0%, 100% { height: 0.5rem; }
    50% { height: 3rem; }
}

.listening-wave {
    animation: listening-wave 0.8s ease-in-out infinite;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function speakingPractice() {
    return {
        // Session state
        sessionActive: false,
        isPaused: false,
        micOn: false,
        showAnalytics: false,
        
        // Practice settings
        practiceType: 'free',
        
        // Conversation tracking
        conversation: [],
        currentTurn: 'ai', // 'ai' or 'student'
        
        // Real-time transcription
        studentTranscript: '',
        aiTranscript: '',
        interimTranscript: '',
        
        // Session stats
        startTime: null,
        duration: 0,
        exchangeCount: 0,
        wordCount: 0,
        durationInterval: null,
        
        // Voice APIs
        recognition: null,
        synthesis: window.speechSynthesis,
        
        // UI state
        isListening: false,
        isSpeaking: false,
        analysisData: null,
        
        // Initialize
        init() {
            this.initVoiceRecognition();
        },
        
        // Initialize speech recognition
        initVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please use Chrome or Edge.');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            this.recognition = new SpeechRecognition();
            
            this.recognition.continuous = false;
            this.recognition.interimResults = true;
            this.recognition.lang = 'en-IN';
            
            this.recognition.onstart = () => {
                this.isListening = true;
            };
            
            this.recognition.onresult = (event) => {
                let interim = '';
                let final = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        final += transcript;
                    } else {
                        interim += transcript;
                    }
                }
                
                if (interim) {
                    this.interimTranscript = interim;
                }
                
                if (final) {
                    this.onStudentSpeechEnd(final);
                }
            };
            
            this.recognition.onend = () => {
                this.isListening = false;
                this.interimTranscript = '';
            };
            
            this.recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                this.isListening = false;
                if (event.error !== 'no-speech') {
                    alert('Speech recognition error: ' + event.error);
                }
            };
        },
        
        // Get practice type label
        getPracticeTypeLabel() {
            const labels = {
                'free': 'Free Conversation',
                'topic': 'Topic-Based Discussion',
                'presentation': 'Presentation Practice',
                'interview': 'Interview Simulation'
            };
            return labels[this.practiceType] || '';
        },
        
        // Format time display
        formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        },
        
        // Start session
        startSession() {
            this.sessionActive = true;
            this.startTime = Date.now();
            this.duration = 0;
            this.conversation = [];
            this.exchangeCount = 0;
            this.wordCount = 0;
            this.micOn = true;
            
            // Start timer
            this.durationInterval = setInterval(() => {
                this.duration++;
            }, 1000);
            
            // AI starts conversation
            this.aiSpeak("Hello! I'm your speaking practice tutor. Let's have a great conversation today. Tell me, what would you like to talk about?");
        },
        
        // Toggle microphone
        toggleMic() {
            this.micOn = !this.micOn;
            if (!this.micOn && this.isListening) {
                this.stopSpeaking();
            }
        },
        
        // Start speaking
        startSpeaking() {
            if (!this.micOn || this.currentTurn !== 'student') return;
            
            try {
                this.recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
            }
        },
        
        // Stop speaking
        stopSpeaking() {
            if (!this.isListening) return;
            
            try {
                this.recognition.stop();
            } catch (error) {
                console.error('Error stopping recognition:', error);
            }
        },
        
        // Handle student speech end
        onStudentSpeechEnd(transcript) {
            this.studentTranscript = transcript;
            this.interimTranscript = '';
            
            // Save to conversation
            this.conversation.push({
                speaker: 'student',
                text: transcript,
                timestamp: this.duration
            });
            
            this.wordCount += transcript.split(' ').length;
            this.exchangeCount++;
            
            // AI responds
            this.getAIResponse(transcript);
        },
        
        // Get AI response
        async getAIResponse(studentText) {
            this.currentTurn = 'ai';
            
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            try {
                const response = await fetch('{% url "students:speaking_practice_respond" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        student_message: studentText,
                        conversation_history: this.conversation,
                        practice_type: this.practiceType
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const aiResponse = data.response;
                    
                    // Save AI response
                    this.conversation.push({
                        speaker: 'ai',
                        text: aiResponse,
                        timestamp: this.duration
                    });
                    
                    // Speak AI response
                    this.aiSpeak(aiResponse);
                } else {
                    alert('Error getting AI response');
                    this.currentTurn = 'student';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error getting AI response');
                this.currentTurn = 'student';
            }
        },
        
        // AI speaks
        aiSpeak(text) {
            this.isSpeaking = true;
            this.aiTranscript = text;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-IN';
            utterance.rate = 0.9;
            
            utterance.onend = () => {
                this.isSpeaking = false;
                this.currentTurn = 'student';
            };
            
            utterance.onerror = () => {
                this.isSpeaking = false;
                this.currentTurn = 'student';
            };
            
            this.synthesis.speak(utterance);
        },
        
        // Confirm end session
        confirmEndSession() {
            if (confirm('Are you sure you want to end this session? You will receive detailed feedback.')) {
                this.endSession();
            }
        },
        
        // End session and get analytics
        async endSession() {
            this.sessionActive = false;
            clearInterval(this.durationInterval);
            
            // Stop any ongoing speech
            this.synthesis.cancel();
            if (this.recognition) {
                try {
                    this.recognition.stop();
                } catch (e) {}
            }
            
            // Show loading
            this.showAnalytics = true;
            this.analysisData = { loading: true };
            
            // Get analysis
            await this.getAnalytics();
        },
        
        // Get detailed analytics
        async getAnalytics() {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            try {
                const response = await fetch('{% url "students:analyze_speaking_session" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        conversation: this.conversation,
                        duration: this.duration,
                        practice_type: this.practiceType
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    this.analysisData = data;
                } else {
                    alert('Error getting analysis: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error getting analysis');
            }
        },
        
        // Reset session
        resetSession() {
            this.sessionActive = false;
            this.showAnalytics = false;
            this.conversation = [];
            this.duration = 0;
            this.exchangeCount = 0;
            this.wordCount = 0;
            this.analysisData = null;
            this.micOn = false;
            this.studentTranscript = '';
            this.aiTranscript = '';
            this.currentTurn = 'ai';
        }
    };
}
</script>
{% endblock %}
