{% extends 'base_new.html' %}

{% block title %}AI Chatbot - NCERT Learning{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8" x-data="chatbot()">
    <!-- Header -->
    <div class="mb-6 fade-in">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fas fa-robot text-blue-500 mr-2"></i>
            AI Tutor
        </h1>
        <p class="text-gray-600">Ask any question about your NCERT curriculum. I'm here to help!</p>
    </div>
    
    <!-- Model Selection & Voice Controls -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-4 fade-in">
        <div class="flex items-center justify-between mb-4">
            <label class="text-sm font-semibold text-gray-700">AI Model:</label>
            <div class="flex space-x-4">
                <label class="flex items-center cursor-pointer">
                    <input type="radio" name="model" value="openai" x-model="selectedModel" class="mr-2">
                    <span class="text-sm">OpenAI GPT-4</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="radio" name="model" value="gemini" x-model="selectedModel" class="mr-2">
                    <span class="text-sm">Google Gemini</span>
                </label>
            </div>
        </div>
        
        <!-- Voice Mode Controls -->
        <div class="border-t pt-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-microphone text-purple-500 text-xl"></i>
                    <div>
                        <label class="text-sm font-semibold text-gray-700">Voice Conversation Mode</label>
                        <p class="text-xs text-gray-500">Talk to AI and hear responses</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Voice Mode Toggle -->
                    <button 
                        @click="toggleVoiceMode()" 
                        class="px-4 py-2 rounded-lg font-semibold transition-all duration-300"
                        :class="voiceMode ? 'bg-purple-500 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'">
                        <i class="fas" :class="voiceMode ? 'fa-microphone' : 'fa-microphone-slash'"></i>
                        <span class="ml-2" x-text="voiceMode ? 'Voice ON' : 'Voice OFF'"></span>
                    </button>
                    
                    <!-- Hold to Speak Button (only when voice mode is on) -->
                    <button 
                        x-show="voiceMode && !isSpeaking"
                        @mousedown="startListening()" 
                        @mouseup="stopListening()"
                        @touchstart="startListening()"
                        @touchend="stopListening()"
                        :disabled="isTyping"
                        class="px-6 py-2 rounded-lg font-semibold transition-all duration-300 relative overflow-hidden"
                        :class="isListening ? 'bg-red-500 text-white animate-pulse' : 'bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:from-purple-600 hover:to-pink-600'">
                        <i class="fas fa-microphone-alt mr-2"></i>
                        <span x-text="isListening ? 'Listening...' : 'Hold to Speak'"></span>
                        <span x-show="isListening" class="absolute inset-0 bg-red-600 opacity-50 animate-ping"></span>
                    </button>
                    
                    <!-- Stop Speaking Button (only when AI is speaking) -->
                    <button 
                        x-show="voiceMode && isSpeaking"
                        @click="stopSpeaking()"
                        class="px-6 py-2 rounded-lg font-semibold transition-all duration-300 bg-red-500 hover:bg-red-600 text-white shadow-lg animate-pulse">
                        <i class="fas fa-stop-circle mr-2"></i>
                        <span>Stop Speaking</span>
                    </button>
                </div>
            </div>
            
            <!-- Voice Status Indicators & Controls -->
            <div x-show="voiceMode" class="mt-3 space-y-3">
                <!-- Status Row -->
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center space-x-4">
                        <!-- Listening Status -->
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 rounded-full" :class="isListening ? 'bg-red-500 animate-pulse' : 'bg-gray-300'"></div>
                            <span class="text-gray-600" x-text="isListening ? 'Listening to your voice...' : 'Ready to listen'"></span>
                        </div>
                        
                        <!-- Speaking Status -->
                        <div x-show="isSpeaking" class="flex items-center space-x-2">
                            <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>
                            <span class="text-gray-600">AI is speaking...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Voice Settings Panel -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <!-- Voice Selection -->
                        <div>
                            <label class="text-xs font-semibold text-gray-700 mb-1 block flex items-center">
                                <i class="fas fa-user-circle mr-1"></i>
                                Voice Character
                            </label>
                            <select 
                                @change="changeVoice($event.target.value)"
                                class="w-full text-xs border border-gray-300 rounded px-2 py-1.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                <template x-for="(voiceOption, index) in availableVoices" :key="index">
                                    <option :value="index" x-text="voiceOption.displayName"></option>
                                </template>
                            </select>
                        </div>
                        
                        <!-- Speech Speed -->
                        <div>
                            <label class="text-xs font-semibold text-gray-700 mb-1 block flex items-center justify-between">
                                <span><i class="fas fa-tachometer-alt mr-1"></i>Speed</span>
                                <span class="text-purple-600" x-text="voiceRate.toFixed(1) + 'x'"></span>
                            </label>
                            <input 
                                type="range" 
                                x-model.number="voiceRate" 
                                min="0.5" 
                                max="2.0" 
                                step="0.1"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-500">
                            <div class="flex justify-between text-xs text-gray-500 mt-0.5">
                                <span>Slow</span>
                                <span>Fast</span>
                            </div>
                        </div>
                        
                        <!-- Voice Pitch -->
                        <div>
                            <label class="text-xs font-semibold text-gray-700 mb-1 block flex items-center justify-between">
                                <span><i class="fas fa-music mr-1"></i>Pitch</span>
                                <span class="text-purple-600" x-text="voicePitch.toFixed(1)"></span>
                            </label>
                            <input 
                                type="range" 
                                x-model.number="voicePitch" 
                                min="0.5" 
                                max="2.0" 
                                step="0.1"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-500">
                            <div class="flex justify-between text-xs text-gray-500 mt-0.5">
                                <span>Low</span>
                                <span>High</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Test Voice Button -->
                    <div class="mt-2 flex items-center justify-between">
                        <button 
                            @click="speakResponse('Hello! This is a test of the selected voice. How does it sound?')"
                            :disabled="isSpeaking"
                            class="text-xs px-3 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded font-semibold transition disabled:opacity-50">
                            <i class="fas fa-volume-up mr-1"></i>
                            Test Voice
                        </button>
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            <span x-text="availableVoices.length + ' voices available'"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Browser Compatibility Warning -->
            <div x-show="!speechSupported && voiceMode" class="mt-3 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <div class="flex items-start space-x-2">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5"></i>
                    <div class="text-xs text-yellow-800">
                        <strong>Voice features not fully supported in this browser.</strong>
                        <br>For best experience, use Chrome, Edge, or Safari.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat Container -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden fade-in">
        <!-- Messages Area -->
        <div id="chatMessages" class="h-[500px] overflow-y-auto p-6 space-y-4 bg-gray-50">
            <!-- Welcome Message -->
            <div class="chat-bubble flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white">
                        <i class="fas fa-robot"></i>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="bg-white rounded-lg shadow p-4">
                        <p class="text-gray-800">
                            Hello! I'm your AI tutor. Ask me anything about your NCERT subjects like Mathematics, 
                            Science, Social Studies, and more. I'm here to help you learn!
                        </p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">AI Tutor ‚Ä¢ Just now</p>
                </div>
            </div>
            
            <!-- Messages will be added here dynamically -->
            <template x-for="(message, index) in messages" :key="index">
                <div class="chat-bubble" :class="message.isUser ? 'flex-row-reverse' : 'flex-row'" 
                     class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white"
                             :class="message.isUser ? 'bg-purple-500' : 'bg-blue-500'">
                            <i :class="message.isUser ? 'fas fa-user' : 'fas fa-robot'"></i>
                        </div>
                    </div>
                    <div class="flex-1 max-w-3xl">
                        <div class="rounded-lg shadow p-4"
                             :class="message.isUser ? 'bg-purple-100' : 'bg-white'">
                            
                            <!-- Text Content with Markdown rendering -->
                            <div class="prose prose-sm max-w-none text-gray-800 markdown-content" 
                                 x-html="message.formattedText || message.text"></div>
                            
                            <!-- Images Section (if not user message) -->
                            <template x-if="!message.isUser && message.images && message.images.length > 0">
                                <div class="mt-4 space-y-3">
                                    <div class="flex items-center text-sm font-semibold text-gray-700 border-t pt-3">
                                        <i class="fas fa-images mr-2 text-blue-500"></i>
                                        <span>Related Images</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <template x-for="(image, imgIndex) in message.images.slice(0, 4)" :key="imgIndex">
                                            <div class="relative group cursor-pointer" 
                                                 @click="openImageModal(image)">
                                                <img :src="image.url" 
                                                     :alt="'Image ' + (imgIndex + 1)"
                                                     class="w-full h-32 object-cover rounded-lg border-2 border-gray-200 hover:border-blue-400 transition">
                                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition rounded-lg flex items-center justify-center">
                                                    <i class="fas fa-search-plus text-white opacity-0 group-hover:opacity-100 transition text-xl"></i>
                                                </div>
                                                <!-- Image source badge -->
                                                <template x-if="image.type">
                                                    <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                                                        <span x-text="image.type === 'ai_generated' ? 'üé® AI' : 'üåê Web'"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Sources/References Section -->
                            <template x-if="!message.isUser && message.sources && message.sources.length > 0">
                                <div class="mt-4 space-y-2">
                                    <div class="flex items-center text-sm font-semibold text-gray-700 border-t pt-3">
                                        <i class="fas fa-book-open mr-2 text-green-500"></i>
                                        <span>Sources & References</span>
                                    </div>
                                    <div class="space-y-2">
                                        <template x-for="(source, srcIndex) in message.sources" :key="srcIndex">
                                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm">
                                                <!-- NCERT Textbook Source -->
                                                <template x-if="source.type === 'ncert_textbook'">
                                                    <div class="flex items-start space-x-2">
                                                        <div class="flex-shrink-0">
                                                            <span class="inline-block px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded">
                                                                üìö NCERT
                                                            </span>
                                                        </div>
                                                        <div class="flex-1">
                                                            <p class="font-medium text-gray-800" x-text="source.name"></p>
                                                            <p class="text-xs text-gray-600 mt-1">
                                                                <span x-text="source.class"></span>
                                                                <template x-if="source.chapter">
                                                                    <span> ‚Ä¢ <span x-text="source.chapter"></span></span>
                                                                </template>
                                                                <template x-if="source.page">
                                                                    <span> ‚Ä¢ Page <span x-text="source.page"></span></span>
                                                                </template>
                                                                <template x-if="source.relevance">
                                                                    <span class="ml-2 text-blue-600 font-semibold">
                                                                        ‚úì <span x-text="source.relevance"></span> match
                                                                    </span>
                                                                </template>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </template>
                                                
                                                <!-- Web Source -->
                                                <template x-if="source.type !== 'ncert_textbook'">
                                                    <div class="flex items-start space-x-2">
                                                        <div class="flex-shrink-0">
                                                            <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded">
                                                                üåê Web
                                                            </span>
                                                        </div>
                                                        <div class="flex-1">
                                                            <template x-if="source.url">
                                                                <a :href="source.url" 
                                                                   target="_blank"
                                                                   class="font-medium text-blue-600 hover:text-blue-800 hover:underline"
                                                                   x-text="source.name"></a>
                                                            </template>
                                                            <template x-if="!source.url">
                                                                <p class="font-medium text-gray-800" x-text="source.name"></p>
                                                            </template>
                                                            <template x-if="source.url">
                                                                <p class="text-xs text-gray-500 mt-1 truncate" x-text="source.url"></p>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Content Source Badge -->
                            <template x-if="!message.isUser && message.contentSource">
                                <div class="mt-3 flex items-center text-xs text-gray-500">
                                    <template x-if="message.contentSource === 'ncert_textbook'">
                                        <span class="flex items-center">
                                            <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                            Based on NCERT textbook content
                                        </span>
                                    </template>
                                </div>
                            </template>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-1" 
                           :class="message.isUser ? 'text-right' : 'text-left'">
                            <span x-text="message.isUser ? 'You' : 'AI Tutor'"></span> ‚Ä¢ 
                            <span x-text="message.time"></span>
                        </p>
                    </div>
                </div>
            </template>
            
            <!-- Typing Indicator -->
            <div x-show="isTyping" class="chat-bubble flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white">
                        <i class="fas fa-robot"></i>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="bg-white rounded-lg shadow p-4">
                        <div class="typing-indicator flex space-x-1">
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="border-t border-gray-200 p-4 bg-white">
            <form @submit.prevent="sendMessage" class="flex space-x-2">
                <!-- Voice Input Button (mobile-friendly) -->
                <button 
                    x-show="voiceMode"
                    type="button"
                    @click="toggleVoiceInput()"
                    :class="isListening ? 'bg-red-500 animate-pulse' : 'bg-purple-500 hover:bg-purple-600'"
                    class="px-4 py-3 text-white rounded-lg transition duration-300">
                    <i class="fas" :class="isListening ? 'fa-stop' : 'fa-microphone'"></i>
                </button>
                
                <input 
                    type="text" 
                    x-model="currentMessage"
                    :placeholder="voiceMode ? 'Type or use voice...' : 'Ask your question here...'"
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    :disabled="isTyping"
                >
                <button 
                    type="submit"
                    class="px-6 py-3 gradient-bg text-white rounded-lg font-semibold hover:opacity-90 transition disabled:opacity-50"
                    :disabled="!currentMessage.trim() || isTyping">
                    <i class="fas fa-paper-plane mr-2"></i>Send
                </button>
            </form>
            
            <!-- Voice transcript display -->
            <div x-show="isListening && interimTranscript" class="mt-2 text-sm text-gray-600 italic">
                <i class="fas fa-microphone text-red-500 animate-pulse mr-2"></i>
                <span x-text="interimTranscript"></span>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
/* Markdown Content Styling */
.markdown-content h1, .markdown-content h2, .markdown-content h3, 
.markdown-content h4, .markdown-content h5, .markdown-content h6 {
    font-weight: 700;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    color: #1f2937;
}

.markdown-content h1 { font-size: 1.5rem; }
.markdown-content h2 { font-size: 1.35rem; }
.markdown-content h3 { font-size: 1.2rem; }
.markdown-content h4 { font-size: 1.1rem; }

.markdown-content strong {
    font-weight: 700;
    color: #1f2937;
}

.markdown-content em {
    font-style: italic;
}

.markdown-content p {
    margin-bottom: 0.75rem;
    line-height: 1.6;
}

.markdown-content ul, .markdown-content ol {
    margin-left: 1.5rem;
    margin-bottom: 0.75rem;
}

.markdown-content li {
    margin-bottom: 0.25rem;
}

.markdown-content code {
    background-color: #f3f4f6;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-family: monospace;
    font-size: 0.875em;
}

.markdown-content blockquote {
    border-left: 4px solid #3b82f6;
    padding-left: 1rem;
    margin: 1rem 0;
    color: #4b5563;
    font-style: italic;
}

/* Image Modal */
.image-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.image-modal img {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
}

/* Voice Mode Animations */
@keyframes pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.7;
        transform: scale(1.05);
    }
}

@keyframes ping {
    75%, 100% {
        transform: scale(2);
        opacity: 0;
    }
}

.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.animate-ping {
    animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
}

/* Listening indicator */
.listening-wave {
    animation: listening-wave 1.5s ease-in-out infinite;
}

@keyframes listening-wave {
    0%, 100% {
        height: 0.5rem;
    }
    50% {
        height: 1.5rem;
    }
}

/* Voice button hover effects */
.voice-btn-hover {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.voice-btn-hover:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.voice-btn-hover:active {
    transform: translateY(0);
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
}

/* Speaking indicator glow */
.speaking-glow {
    animation: speaking-glow 2s ease-in-out infinite;
}

@keyframes speaking-glow {
    0%, 100% {
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    }
    50% {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
function chatbot() {
    return {
        messages: [],
        currentMessage: '',
        isTyping: false,
        selectedModel: 'openai',
        imageModal: null,
        
        // Voice Conversation Features
        voiceMode: false,
        isListening: false,
        isSpeaking: false,
        recognition: null,
        synthesis: window.speechSynthesis,
        voiceLang: 'en-IN',
        speechSupported: false,
        interimTranscript: '',
        availableVoices: [],
        selectedVoice: null,
        voiceRate: 0.9,
        voicePitch: 1.0,
        
        // Initialize voice features on component load
        init() {
            this.initVoiceRecognition();
            this.checkSpeechSupport();
            this.loadAvailableVoices();
        },
        
        // Check browser support for speech features
        checkSpeechSupport() {
            const hasRecognition = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
            const hasSynthesis = ('speechSynthesis' in window);
            this.speechSupported = hasRecognition && hasSynthesis;
            
            if (!this.speechSupported) {
                console.warn('Speech features not fully supported in this browser');
            }
        },
        
        // Load available voices from browser
        loadAvailableVoices() {
            if (!this.synthesis) return;
            
            const loadVoices = () => {
                const voices = this.synthesis.getVoices();
                
                // Filter for English voices (Indian, US, UK, Australian)
                this.availableVoices = voices.filter(voice => 
                    voice.lang.startsWith('en-') || voice.lang === 'en'
                ).map(voice => ({
                    voice: voice,
                    name: voice.name,
                    lang: voice.lang,
                    gender: this.detectGender(voice.name),
                    displayName: this.formatVoiceName(voice.name, voice.lang)
                }));
                
                // Set default voice (prefer Indian English female)
                if (this.availableVoices.length > 0) {
                    const defaultVoice = this.availableVoices.find(v => 
                        v.lang === 'en-IN' && v.gender === 'female'
                    ) || this.availableVoices.find(v => 
                        v.lang === 'en-IN'
                    ) || this.availableVoices[0];
                    
                    this.selectedVoice = defaultVoice.voice;
                    console.log(`Default voice: ${defaultVoice.displayName}`);
                }
                
                console.log(`Loaded ${this.availableVoices.length} English voices`);
            };
            
            // Load voices (some browsers need this event)
            loadVoices();
            if (this.synthesis.onvoiceschanged !== undefined) {
                this.synthesis.onvoiceschanged = loadVoices;
            }
        },
        
        // Detect gender from voice name (heuristic)
        detectGender(name) {
            const nameLower = name.toLowerCase();
            if (nameLower.includes('female') || nameLower.includes('woman') || 
                nameLower.includes('samantha') || nameLower.includes('karen') ||
                nameLower.includes('moira') || nameLower.includes('tessa') ||
                nameLower.includes('veena') || nameLower.includes('rishi')) {
                return 'female';
            } else if (nameLower.includes('male') || nameLower.includes('man') ||
                       nameLower.includes('daniel') || nameLower.includes('thomas') ||
                       nameLower.includes('oliver') || nameLower.includes('alex')) {
                return 'male';
            }
            return 'neutral';
        },
        
        // Format voice name for display
        formatVoiceName(name, lang) {
            // Extract meaningful name parts
            let displayName = name.replace(/Microsoft|Google|Apple|Enhanced|Natural|Neural|TTS/gi, '').trim();
            
            // Add language info
            const langNames = {
                'en-IN': 'üáÆüá≥ Indian',
                'en-US': 'üá∫üá∏ American',
                'en-GB': 'üá¨üáß British',
                'en-AU': 'üá¶üá∫ Australian'
            };
            
            const langLabel = langNames[lang] || lang;
            return `${displayName} (${langLabel})`;
        },
        
        // Change voice
        changeVoice(voiceIndex) {
            if (voiceIndex >= 0 && voiceIndex < this.availableVoices.length) {
                this.selectedVoice = this.availableVoices[voiceIndex].voice;
                console.log(`Voice changed to: ${this.availableVoices[voiceIndex].displayName}`);
            }
        },
        
        // Initialize Speech Recognition (STT)
        initVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('Speech Recognition not supported');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            this.recognition = new SpeechRecognition();
            
            // Configuration
            this.recognition.continuous = false; // Stop after user finishes speaking
            this.recognition.interimResults = true; // Show real-time transcription
            this.recognition.maxAlternatives = 1;
            
            // Event: Recognition starts
            this.recognition.onstart = () => {
                console.log('Voice recognition started');
                this.isListening = true;
                this.interimTranscript = '';
            };
            
            // Event: Real-time results
            this.recognition.onresult = (event) => {
                let interim = '';
                let final = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        final += transcript;
                    } else {
                        interim += transcript;
                    }
                }
                
                // Show interim transcript (real-time)
                if (interim) {
                    this.interimTranscript = interim;
                }
                
                // Set final transcript
                if (final) {
                    this.currentMessage = final;
                    this.interimTranscript = '';
                }
            };
            
            // Event: Recognition ends
            this.recognition.onend = () => {
                console.log('Voice recognition ended');
                this.isListening = false;
                this.interimTranscript = '';
                
                // VALIDATION: Check if message is complete and meaningful
                if (this.currentMessage.trim()) {
                    const isValid = this.validateVoiceInput(this.currentMessage);
                    
                    if (isValid.valid) {
                        // Auto-send valid message
                        setTimeout(() => this.sendMessage(), 300);
                    } else {
                        // Show error and keep text in input for user to edit
                        this.showVoiceError(isValid.error);
                        // Clear input after 3 seconds
                        setTimeout(() => {
                            if (this.currentMessage === isValid.originalText) {
                                this.currentMessage = '';
                            }
                        }, 3000);
                    }
                }
            };
            
            // Event: Recognition error
            this.recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                this.isListening = false;
                this.interimTranscript = '';
                
                // Show user-friendly error messages
                if (event.error === 'no-speech') {
                    this.showVoiceError('No speech detected. Please try again.');
                } else if (event.error === 'audio-capture') {
                    this.showVoiceError('Microphone not found. Please check your device.');
                } else if (event.error === 'not-allowed') {
                    this.showVoiceError('Microphone permission denied. Please allow access.');
                } else {
                    this.showVoiceError('Voice recognition error. Please try again.');
                }
            };
        },
        
        // Toggle voice mode on/off
        toggleVoiceMode() {
            this.voiceMode = !this.voiceMode;
            
            if (this.voiceMode) {
                console.log('Voice mode enabled');
                // Stop any ongoing speech
                if (this.synthesis.speaking) {
                    this.synthesis.cancel();
                }
            } else {
                console.log('Voice mode disabled');
                // Stop listening and speaking
                if (this.isListening) {
                    this.stopListening();
                }
                if (this.synthesis.speaking) {
                    this.synthesis.cancel();
                    this.isSpeaking = false;
                }
            }
        },
        
        // Start voice input (for desktop - hold button)
        startListening() {
            if (!this.recognition || !this.voiceMode || this.isListening) return;
            
            try {
                // Set language before starting
                this.recognition.lang = this.voiceLang;
                this.recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
            }
        },
        
        // Stop voice input (for desktop - release button)
        stopListening() {
            if (!this.recognition || !this.isListening) return;
            
            try {
                this.recognition.stop();
            } catch (error) {
                console.error('Error stopping recognition:', error);
            }
        },
        
        // Toggle voice input (for mobile - tap button)
        toggleVoiceInput() {
            if (this.isListening) {
                this.stopListening();
            } else {
                this.startListening();
            }
        },
        
        // Text-to-Speech: Speak AI response
        speakResponse(text) {
            if (!this.voiceMode || !this.synthesis) return;
            
            // Cancel any ongoing speech
            if (this.synthesis.speaking) {
                this.synthesis.cancel();
            }
            
            // Remove markdown formatting for cleaner speech
            const cleanText = this.cleanTextForSpeech(text);
            
            // Create utterance
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = this.voiceLang;
            utterance.rate = this.voiceRate;
            utterance.pitch = this.voicePitch;
            utterance.volume = 1.0;
            
            // Apply selected voice
            if (this.selectedVoice) {
                utterance.voice = this.selectedVoice;
            }
            
            // Events
            utterance.onstart = () => {
                console.log('AI started speaking');
                this.isSpeaking = true;
            };
            
            utterance.onend = () => {
                console.log('AI finished speaking');
                this.isSpeaking = false;
            };
            
            utterance.onerror = (event) => {
                console.error('Speech synthesis error:', event.error);
                this.isSpeaking = false;
            };
            
            // Speak!
            this.synthesis.speak(utterance);
        },
        
        // Clean text for speech (remove markdown, special chars)
        cleanTextForSpeech(text) {
            return text
                // Remove markdown headers
                .replace(/#{1,6}\s+(.*?)(\n|$)/g, '$1. ')
                // Remove bold/italic
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/\*(.*?)\*/g, '$1')
                // Remove bullet points
                .replace(/^\s*[-*]\s+/gm, '')
                // Remove numbered lists
                .replace(/^\s*\d+\.\s+/gm, '')
                // üéØ REMOVE EMOJIS - Prevents reading "thinking face", "smiling face with eyes"
                // This regex removes all emoji characters (Unicode ranges)
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '')  // Emoticons
                .replace(/[\u{1F300}-\u{1F5FF}]/gu, '')  // Misc Symbols and Pictographs
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')  // Transport and Map
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '')  // Regional country flags
                .replace(/[\u{2600}-\u{26FF}]/gu, '')    // Misc symbols
                .replace(/[\u{2700}-\u{27BF}]/gu, '')    // Dingbats
                .replace(/[\u{1F900}-\u{1F9FF}]/gu, '')  // Supplemental Symbols and Pictographs
                .replace(/[\u{1FA00}-\u{1FA6F}]/gu, '')  // Chess Symbols
                .replace(/[\u{1FA70}-\u{1FAFF}]/gu, '')  // Symbols and Pictographs Extended-A
                .replace(/[\u{FE00}-\u{FE0F}]/gu, '')    // Variation Selectors
                .replace(/[\u{1F910}-\u{1F96B}]/gu, '')  // Additional emoticons
                .replace(/[\u{1F980}-\u{1F9E0}]/gu, '')  // Additional animals and nature
                // Remove common emoji shortcodes that might be spoken
                .replace(/:[a-z_]+:/gi, '')               // :smile:, :thumbs_up:, etc.
                // Remove excessive newlines
                .replace(/\n{3,}/g, '. ')
                .replace(/\n{2}/g, '. ')
                .replace(/\n/g, ' ')
                // Remove HTML tags (if any)
                .replace(/<[^>]*>/g, '')
                // Clean up spaces
                .replace(/\s{2,}/g, ' ')
                .trim();
        },
        
        // Validate voice input before sending
        validateVoiceInput(text) {
            const trimmed = text.trim();
            const wordCount = trimmed.split(/\s+/).filter(w => w.length > 0).length;
            
            // Check 1: Minimum word count (at least 3 words for a meaningful question)
            if (wordCount < 3) {
                return {
                    valid: false,
                    error: '‚ùå Question too short. Please speak at least 3 words. Example: "What is photosynthesis?"',
                    originalText: trimmed
                };
            }
            
            // Check 2: Check for common incomplete phrases
            const incompletePhrases = [
                /^(let me know|tell me|explain|what are|show me|can you)(\s+(what|all|the|about)?)?$/i,
                /^(what|where|when|why|how|who)(\s+(is|are|the|a))?$/i,
                /^(i want to|i need|please|can|could)(\s+(know|learn|ask))?$/i
            ];
            
            for (const pattern of incompletePhrases) {
                if (pattern.test(trimmed)) {
                    return {
                        valid: false,
                        error: '‚ùå Incomplete question detected. Please complete your sentence. Example: "What is the water cycle?"',
                        originalText: trimmed
                    };
                }
            }
            
            // Check 3: Check if it ends meaningfully (has at least a subject and potential verb)
            // This catches cases like "let me know what are all the"
            if (trimmed.match(/(^|\s)(the|a|an|all|what|which|where)$/i)) {
                return {
                    valid: false,
                    error: '‚ùå Question appears incomplete. Did you finish speaking? Try again with a complete question.',
                    originalText: trimmed
                };
            }
            
            // Check 4: Minimum character length
            if (trimmed.length < 10) {
                return {
                    valid: false,
                    error: '‚ùå Question too short. Please ask a complete question about your NCERT textbook.',
                    originalText: trimmed
                };
            }
            
            // Check 5: Check for gibberish (too many repeated characters)
            if (/(.)\1{4,}/.test(trimmed)) {
                return {
                    valid: false,
                    error: '‚ùå Invalid input detected. Please speak clearly and try again.',
                    originalText: trimmed
                };
            }
            
            // All checks passed
            return {
                valid: true,
                error: null,
                originalText: trimmed
            };
        },
        
        // Show voice error as a message
        showVoiceError(errorText) {
            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            this.messages.push({
                text: errorText,
                formattedText: `<div class="text-yellow-600 bg-yellow-50 p-3 rounded-lg border border-yellow-200"><i class="fas fa-exclamation-triangle mr-2"></i>${errorText}</div>`,
                isUser: false,
                time: now
            });
            
            // Auto-scroll to show error
            this.$nextTick(() => {
                const chatBox = document.getElementById('chatMessages');
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        },
        
        // Stop AI from speaking (interrupt)
        stopSpeaking() {
            if (this.synthesis && this.synthesis.speaking) {
                this.synthesis.cancel();
                this.isSpeaking = false;
                console.log('Speech interrupted by user');
                
                // Show feedback
                const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                this.messages.push({
                    text: 'Speech stopped',
                    formattedText: '<div class="text-gray-500 italic text-sm"><i class="fas fa-stop-circle mr-2"></i>You stopped the AI from speaking</div>',
                    isUser: false,
                    time: now
                });
            }
        },
        
        // Format Markdown to HTML
        formatMarkdown(text) {
            if (!text) return '';
            
            // Convert markdown to HTML using marked.js
            try {
                // Configure marked for better formatting
                marked.setOptions({
                    breaks: true,
                    gfm: true
                });
                return marked.parse(text);
            } catch (e) {
                // Fallback: Basic markdown conversion
                return text
                    .replace(/### (.*?)(\n|$)/g, '<h3>$1</h3>')
                    .replace(/## (.*?)(\n|$)/g, '<h2>$1</h2>')
                    .replace(/# (.*?)(\n|$)/g, '<h1>$1</h1>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');
            }
        },
        
        // Open image in modal
        openImageModal(image) {
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="relative">
                    <img src="${image.url}" alt="Full size image">
                    <button onclick="this.closest('.image-modal').remove()" 
                            class="absolute top-4 right-4 bg-white text-gray-800 rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-200 transition">
                        <i class="fas fa-times"></i>
                    </button>
                    ${image.source ? `<div class="absolute bottom-4 left-4 bg-black bg-opacity-70 text-white px-3 py-2 rounded">Source: ${image.source}</div>` : ''}
                </div>
            `;
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            document.body.appendChild(modal);
        },
        
        sendMessage() {
            if (!this.currentMessage.trim()) return;
            
            const userMessage = this.currentMessage;
            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Add user message
            this.messages.push({
                text: userMessage,
                formattedText: userMessage,
                isUser: true,
                time: now
            });
            
            // Clear input
            this.currentMessage = '';
            
            // Scroll to bottom
            this.$nextTick(() => {
                const chatBox = document.getElementById('chatMessages');
                chatBox.scrollTop = chatBox.scrollHeight;
            });
            
            // Show typing indicator
            this.isTyping = true;
            
            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                            this.getCookie('csrftoken');
            
            // Send to backend
            fetch('{% url "students:ask_chatbot" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                body: new URLSearchParams({
                    'question': userMessage,
                    'model': this.selectedModel
                })
            })
            .then(response => response.json())
            .then(data => {
                this.isTyping = false;
                
                if (data.status === 'success') {
                    const aiTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    // Format the answer with markdown
                    const formattedAnswer = this.formatMarkdown(data.answer);
                    
                    // Create message object with all data
                    const message = {
                        text: data.answer,
                        formattedText: formattedAnswer,
                        isUser: false,
                        time: aiTime,
                        images: data.images || [],
                        sources: data.sources || [],
                        contentSource: data.content_source,
                        ragUsed: data.rag_used || false,
                        difficultyLevel: data.difficulty_level
                    };
                    
                    this.messages.push(message);
                    
                    // üîä VOICE OUTPUT: Speak the AI response if voice mode is on
                    if (this.voiceMode) {
                        this.speakResponse(data.answer);
                    }
                    
                    // Log for debugging
                    console.log('Response data:', {
                        hasImages: data.images && data.images.length > 0,
                        imageCount: data.images ? data.images.length : 0,
                        hasSources: data.sources && data.sources.length > 0,
                        sourceCount: data.sources ? data.sources.length : 0,
                        contentSource: data.content_source,
                        ragUsed: data.rag_used
                    });
                    
                } else {
                    const errorMsg = data.error || 'Sorry, something went wrong. Please try again.';
                    this.messages.push({
                        text: errorMsg,
                        formattedText: errorMsg,
                        isUser: false,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    });
                    
                    // Speak error message if voice mode is on
                    if (this.voiceMode) {
                        this.speakResponse(errorMsg);
                    }
                }
                
                // Scroll to bottom
                this.$nextTick(() => {
                    const chatBox = document.getElementById('chatMessages');
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
            })
            .catch(error => {
                console.error('Error:', error);
                this.isTyping = false;
                this.messages.push({
                    text: 'Network error. Please check your connection and try again.',
                    formattedText: 'Network error. Please check your connection and try again.',
                    isUser: false,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                });
            });
        },
        
        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    };
}
</script>
{% endblock %}
