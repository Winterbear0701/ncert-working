{% extends 'base_new.html' %}
{% load quiz_filters %}

{% block title %}Quiz Analytics - {{ chapter.chapter_name }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            {{ chapter.subject }} - {{ chapter.chapter_name }}
        </h1>
        <p class="text-gray-600">Detailed performance analytics and progress tracking</p>
    </div>

    <!-- No attempts -->
    {% if not attempts %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-12 text-center">
        <svg class="w-20 h-20 mx-auto text-blue-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        <h3 class="text-2xl font-semibold text-gray-900 mb-2">No Data Available</h3>
        <p class="text-gray-600 mb-6">Take this quiz to see detailed analytics!</p>
        <a href="{% url 'start_quiz' chapter.chapter_id %}" 
           class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Start Quiz
        </a>
    </div>
    {% else %}

    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Total Attempts</p>
                    <p class="text-3xl font-bold text-gray-900">{{ attempts|length }}</p>
                </div>
                <svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Best Score</p>
                    <p class="text-3xl font-bold text-green-600">{{ best_score|floatformat:0 }}%</p>
                </div>
                <svg class="w-12 h-12 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Average Score</p>
                    <p class="text-3xl font-bold text-blue-600">{{ average_score|floatformat:0 }}%</p>
                </div>
                <svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Improvement</p>
                    <p class="text-3xl font-bold {% if improvement >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if improvement >= 0 %}+{% endif %}{{ improvement|floatformat:0 }}%
                    </p>
                </div>
                {% if improvement >= 0 %}
                <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
                {% else %}
                <svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
                </svg>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Score Trend Chart -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
            <svg class="w-7 h-7 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
            </svg>
            Score Trend Over Time
        </h2>

        <!-- ASCII Chart -->
        <div class="overflow-x-auto">
            <div class="min-w-full">
                <!-- Y-axis labels and lines -->
                {% for pct in y_axis_values %}
                <div class="flex items-center h-12 {% if pct == 70 %}border-y-2 border-red-300{% endif %}">
                    <span class="w-12 text-right text-sm text-gray-600 pr-2">{{ pct }}%</span>
                    <div class="flex-1 border-t border-gray-200 relative">
                        {% if pct == chapter.passing_percentage|floatformat:0 %}
                        <div class="absolute left-0 w-full border-t-2 border-dashed border-red-400"></div>
                        <span class="absolute left-2 -top-3 text-xs text-red-600 bg-white px-1">Passing Line</span>
                        {% endif %}
                        
                        <!-- Plot points -->
                        <div class="flex justify-between px-4">
                            {% for attempt in attempts %}
                            {% if pct == attempt.score_percentage|floatformat:0|add:"0" %}
                            <div class="relative">
                                <div class="w-4 h-4 rounded-full {% if attempt.is_passed %}bg-green-500{% else %}bg-red-500{% endif %} absolute -top-2 -left-2"></div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <!-- X-axis labels -->
                <div class="flex items-center mt-2">
                    <span class="w-12"></span>
                    <div class="flex-1 flex justify-between px-4 text-sm text-gray-600">
                        {% for attempt in attempts %}
                        <span class="text-center">
                            Att {{ forloop.counter }}<br>
                            <span class="text-xs text-gray-500">{{ attempt.submitted_at|date:"M d" }}</span>
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Scores List -->
        <div class="mt-6 flex flex-wrap gap-4 justify-center">
            {% for attempt in attempts %}
            <div class="flex items-center gap-2 px-4 py-2 rounded-lg {% if attempt.is_passed %}bg-green-50 border border-green-300{% else %}bg-red-50 border border-red-300{% endif %}">
                <span class="font-medium text-gray-700">Attempt {{ forloop.counter }}:</span>
                <span class="text-xl font-bold {% if attempt.is_passed %}text-green-700{% else %}text-red-700{% endif %}">
                    {{ attempt.score_percentage|floatformat:0 }}%
                </span>
                {% if attempt.is_passed %}
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Topic Performance Comparison -->
    {% if topic_averages %}
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
            <svg class="w-7 h-7 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
            </svg>
            Topic Performance Summary
        </h2>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Topic</th>
                        {% for attempt in attempts %}
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Attempt {{ forloop.counter }}
                        </th>
                        {% endfor %}
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Average</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for topic_data in topic_averages.items %}
                    {% with topic=topic_data.0 avg=topic_data.1 %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{{ topic }}</td>
                        {% for attempt in attempts %}
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            {% if topic in attempt.topic_performance %}
                            <span class="px-3 py-1 rounded-full text-sm font-medium"
                                  style="background-color: {% if attempt.topic_performance|get_item:topic|get_item:'percentage' >= 80 %}#d1fae5{% elif attempt.topic_performance|get_item:topic|get_item:'percentage' >= 60 %}#fef3c7{% else %}#fee2e2{% endif %}; 
                                         color: {% if attempt.topic_performance|get_item:topic|get_item:'percentage' >= 80 %}#065f46{% elif attempt.topic_performance|get_item:topic|get_item:'percentage' >= 60 %}#92400e{% else %}#991b1b{% endif %}">
                                {{ attempt.topic_performance|get_item:topic|get_item:'percentage'|floatformat:0 }}%
                            </span>
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="px-3 py-1 rounded-full text-sm font-bold"
                                  style="background-color: {% if avg >= 80 %}#d1fae5{% elif avg >= 60 %}#fef3c7{% else %}#fee2e2{% endif %}; 
                                         color: {% if avg >= 80 %}#065f46{% elif avg >= 60 %}#92400e{% else %}#991b1b{% endif %}">
                                {{ avg|floatformat:0 }}%
                            </span>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Insights & Recommendations -->
    <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow-md p-6 mb-8 border border-purple-200">
        <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
            <svg class="w-7 h-7 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            Insights & Recommendations
        </h2>

        <div class="space-y-3">
            {% if best_score >= chapter.passing_percentage %}
            <div class="flex items-start bg-green-100 rounded-lg p-4">
                <svg class="w-6 h-6 text-green-600 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-green-900"><strong>Congratulations!</strong> You've passed this chapter with {{ best_score|floatformat:0 }}%. The next chapter is now unlocked!</p>
            </div>
            {% else %}
            <div class="flex items-start bg-yellow-100 rounded-lg p-4">
                <svg class="w-6 h-6 text-yellow-600 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <p class="text-yellow-900"><strong>Keep going!</strong> You need {{ chapter.passing_percentage }}% to pass. You're at {{ best_score|floatformat:0 }}% - only {{ chapter.passing_percentage|floatformat:0|add:"-"|add:best_score|floatformat:0 }}% away!</p>
            </div>
            {% endif %}

            {% if improvement > 10 %}
            <div class="flex items-start bg-blue-100 rounded-lg p-4">
                <svg class="w-6 h-6 text-blue-600 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
                <p class="text-blue-900"><strong>Great improvement!</strong> Your score increased by {{ improvement|floatformat:0 }}% from first to last attempt. Keep up the excellent work!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-4 justify-center flex-wrap">
        <a href="{% url 'start_quiz' chapter.chapter_id %}" 
           class="px-8 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium inline-flex items-center text-lg">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Take Quiz Again
        </a>

        <a href="{% url 'quiz_history' %}" 
           class="px-8 py-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium inline-flex items-center text-lg">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            View All History
        </a>

        <a href="{% url 'quiz_dashboard' %}" 
           class="px-8 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium inline-flex items-center text-lg">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
            Quiz Dashboard
        </a>
    </div>

    {% endif %}
</div>
{% endblock %}
