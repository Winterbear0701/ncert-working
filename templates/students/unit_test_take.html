{% extends 'base_new.html' %}
{% load static %}

{% block title %}{{ attempt.unit_test.title }} - Take Test{% endblock %}

{% block extra_css %}
<style>
    .test-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .test-info {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255,255,255,0.2);
        padding: 0.5rem 1rem;
        border-radius: 8px;
    }
    
    .timer-container {
        position: sticky;
        top: 20px;
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        text-align: center;
        border: 3px solid #667eea;
    }
    
    .timer {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
        font-family: 'Courier New', monospace;
        margin-top: 0.5rem;
    }
    
    .timer.warning {
        color: #f59e0b;
        animation: pulse 1s infinite;
    }
    
    .timer.danger {
        color: #ef4444;
        animation: pulse 0.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    .question-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }
    
    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .question-number {
        background: #667eea;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .question-marks {
        background: #10b981;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: bold;
    }
    
    .question-text {
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 1rem;
        color: #1f2937;
    }
    
    .answer-textarea {
        width: 100%;
        min-height: 150px;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        transition: all 0.3s;
    }
    
    .answer-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .answer-textarea.has-content {
        border-color: #10b981;
        background: #f0fdf4;
    }
    
    .char-count {
        text-align: right;
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    .submit-section {
        position: sticky;
        bottom: 20px;
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 -4px 6px rgba(0,0,0,0.1);
        margin-top: 2rem;
        border: 2px solid #667eea;
    }
    
    .progress-bar {
        background: #e5e7eb;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .progress-fill {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        height: 100%;
        transition: width 0.3s;
    }
    
    .submit-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .btn-submit {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 1rem 2rem;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }
    
    .btn-submit:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-save-draft {
        background: #f59e0b;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-save-draft:hover {
        background: #d97706;
    }
    
    .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .alert-warning {
        background: #fef3c7;
        color: #92400e;
        border-left: 4px solid #f59e0b;
    }
    
    .alert-info {
        background: #dbeafe;
        color: #1e40af;
        border-left: 4px solid #3b82f6;
    }
    
    .icon {
        font-size: 1.2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Test Header -->
    <div class="test-header">
        <h1 class="mb-0">
            <i class="fas fa-file-alt"></i>
            {{ attempt.unit_test.title }}
        </h1>
        {% if attempt.unit_test.description %}
        <p class="mb-2 mt-2" style="opacity: 0.9;">{{ attempt.unit_test.description }}</p>
        {% endif %}
        
        <div class="test-info">
            <div class="info-item">
                <i class="fas fa-clipboard-list icon"></i>
                <span>{{ questions|length }} Questions</span>
            </div>
            <div class="info-item">
                <i class="fas fa-star icon"></i>
                <span>{{ attempt.unit_test.total_marks }} Marks</span>
            </div>
            <div class="info-item">
                <i class="fas fa-clock icon"></i>
                <span>{{ attempt.unit_test.duration_minutes }} Minutes</span>
            </div>
            <div class="info-item">
                <i class="fas fa-check-circle icon"></i>
                <span>Passing: {{ attempt.unit_test.passing_percentage }}%</span>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Alert Messages -->
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Instructions:</strong>
                <ul class="mb-0 mt-2">
                    <li>Answer all questions to the best of your ability</li>
                    <li>Your answers will be evaluated by AI for content quality and grammar</li>
                    <li>Click "Save Draft" to save your progress without submitting</li>
                    <li>Timer is running - submit before time runs out!</li>
                </ul>
            </div>

            <!-- Questions Form -->
            <form id="testForm" method="post" action="{% url 'students:unit_test_submit' attempt.id %}">
                {% csrf_token %}
                
                {% for question in questions %}
                <div class="question-card" data-question-id="{{ question.id }}">
                    <div class="question-header">
                        <span class="question-number">
                            Question {{ question.question_number }}
                        </span>
                        <span class="question-marks">
                            <i class="fas fa-award"></i>
                            {{ question.marks }} Marks
                        </span>
                    </div>
                    
                    <div class="question-text">
                        {{ question.question_text|linebreaks }}
                    </div>
                    
                    <div>
                        <label class="form-label fw-bold">
                            <i class="fas fa-pencil-alt"></i>
                            Your Answer:
                        </label>
                        <textarea 
                            name="answer_{{ question.id }}"
                            class="answer-textarea"
                            placeholder="Type your answer here..."
                            data-question-id="{{ question.id }}">{% for q_id, answer in existing_answers.items %}{% if q_id == question.id %}{{ answer }}{% endif %}{% endfor %}</textarea>
                        <div class="char-count">
                            <span class="current-chars">0</span> characters
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Submit Section -->
                <div class="submit-section">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    
                    <div class="submit-info">
                        <div>
                            <strong id="answeredCount">0</strong> of <strong>{{ questions|length }}</strong> questions answered
                        </div>
                        <div>
                            <button type="button" class="btn-save-draft" id="saveDraftBtn">
                                <i class="fas fa-save"></i>
                                Save Draft
                            </button>
                            <button type="submit" class="btn-submit" id="submitBtn">
                                <i class="fas fa-check-circle"></i>
                                Submit Test
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-3">
            <!-- Timer -->
            <div class="timer-container">
                <div>
                    <i class="fas fa-hourglass-half" style="font-size: 1.5rem;"></i>
                </div>
                <div style="font-size: 1rem; font-weight: bold; margin-top: 0.5rem;">Time Remaining</div>
                <div class="timer" id="timer">00:00:00</div>
                <div style="margin-top: 1rem; font-size: 0.875rem; color: #6b7280;">
                    Test will auto-submit when time expires
                </div>
            </div>

            <!-- Question Navigator -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-list"></i>
                    Question Navigator
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% for question in questions %}
                        <button 
                            type="button" 
                            class="btn btn-outline-primary btn-sm nav-btn"
                            data-question="{{ question.id }}"
                            onclick="scrollToQuestion({{ question.id }})">
                            Q{{ question.question_number }}
                            <span class="badge bg-secondary ms-2">{{ question.marks }}m</span>
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Timer functionality
    let remainingSeconds = {{ remaining_seconds }};
    const timerElement = document.getElementById('timer');
    const testForm = document.getElementById('testForm');
    
    function updateTimer() {
        if (remainingSeconds <= 0) {
            // Auto-submit when time runs out
            alert('Time is up! Your test will be submitted automatically.');
            testForm.submit();
            return;
        }
        
        const hours = Math.floor(remainingSeconds / 3600);
        const minutes = Math.floor((remainingSeconds % 3600) / 60);
        const seconds = remainingSeconds % 60;
        
        timerElement.textContent = 
            String(hours).padStart(2, '0') + ':' +
            String(minutes).padStart(2, '0') + ':' +
            String(seconds).padStart(2, '0');
        
        // Change color based on time remaining
        if (remainingSeconds <= 300) { // 5 minutes
            timerElement.classList.add('danger');
            timerElement.classList.remove('warning');
        } else if (remainingSeconds <= 600) { // 10 minutes
            timerElement.classList.add('warning');
            timerElement.classList.remove('danger');
        }
        
        remainingSeconds--;
    }
    
    // Update timer every second
    updateTimer();
    setInterval(updateTimer, 1000);
    
    // Character count and answer tracking
    const textareas = document.querySelectorAll('.answer-textarea');
    
    function updateCharCount(textarea) {
        const charCountElement = textarea.parentElement.querySelector('.current-chars');
        const length = textarea.value.trim().length;
        charCountElement.textContent = length;
        
        // Add visual feedback if answer has content
        if (length > 0) {
            textarea.classList.add('has-content');
        } else {
            textarea.classList.remove('has-content');
        }
    }
    
    function updateProgress() {
        let answeredCount = 0;
        textareas.forEach(textarea => {
            if (textarea.value.trim().length > 0) {
                answeredCount++;
            }
        });
        
        const totalQuestions = textareas.length;
        const percentage = (answeredCount / totalQuestions) * 100;
        
        document.getElementById('answeredCount').textContent = answeredCount;
        document.getElementById('progressFill').style.width = percentage + '%';
        
        // Update navigation buttons
        textareas.forEach(textarea => {
            const questionId = textarea.dataset.questionId;
            const navBtn = document.querySelector(`button[data-question="${questionId}"]`);
            if (navBtn) {
                if (textarea.value.trim().length > 0) {
                    navBtn.classList.remove('btn-outline-primary');
                    navBtn.classList.add('btn-success');
                } else {
                    navBtn.classList.remove('btn-success');
                    navBtn.classList.add('btn-outline-primary');
                }
            }
        });
    }
    
    // Initialize character counts
    textareas.forEach(textarea => {
        updateCharCount(textarea);
        
        textarea.addEventListener('input', function() {
            updateCharCount(this);
            updateProgress();
        });
    });
    
    // Initial progress update
    updateProgress();
    
    // Scroll to question
    function scrollToQuestion(questionId) {
        const questionCard = document.querySelector(`[data-question-id="${questionId}"]`);
        if (questionCard) {
            questionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const textarea = questionCard.querySelector('textarea');
            if (textarea) {
                textarea.focus();
            }
        }
    }
    
    // Save draft functionality
    document.getElementById('saveDraftBtn').addEventListener('click', function() {
        const formData = new FormData(testForm);
        
        fetch('{% url "students:unit_test_save_draft" attempt.id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alert = document.createElement('div');
                alert.className = 'alert alert-info';
                alert.innerHTML = '<i class="fas fa-check-circle"></i> Draft saved successfully!';
                document.querySelector('.col-lg-9').insertBefore(alert, document.querySelector('.question-card'));
                
                setTimeout(() => alert.remove(), 3000);
            }
        })
        .catch(error => {
            alert('Error saving draft. Please try again.');
        });
    });
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Confirm before leaving page
    window.addEventListener('beforeunload', function(e) {
        e.preventDefault();
        e.returnValue = '';
    });
    
    // Submit confirmation
    testForm.addEventListener('submit', function(e) {
        if (!confirm('Are you sure you want to submit your test? You cannot make changes after submission.')) {
            e.preventDefault();
        } else {
            // Remove beforeunload warning
            window.removeEventListener('beforeunload', function() {});
        }
    });
</script>
{% endblock %}
