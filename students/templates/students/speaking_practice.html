{% extends 'base_new.html' %}

{% block title %}AI Speaking Practice - NCERT Learning{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" x-data="speakingPractice()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fas fa-microphone text-purple-500 mr-2"></i>
            AI Speaking Practice
        </h1>
        <p class="text-gray-600">Practice speaking English and get detailed feedback on grammar, fluency, and more!</p>
    </div>

    <!-- Practice Room Card -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Main Practice Area -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <!-- Session Status -->
                <div class="mb-6 text-center">
                    <div x-show="!sessionActive && !analyzing" class="space-y-4">
                        <div class="w-32 h-32 mx-auto bg-gradient-to-br from-purple-100 to-pink-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-microphone text-5xl text-purple-500"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">Ready to Practice?</h2>
                        <p class="text-gray-600">Start a conversation with our AI tutor to improve your speaking skills!</p>
                        
                        <!-- Practice Type Selection -->
                        <div class="mt-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Choose Practice Type:</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button 
                                    @click="practiceType = 'free'"
                                    :class="practiceType === 'free' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                    class="p-4 rounded-lg font-semibold transition">
                                    <i class="fas fa-comments mb-2 text-2xl"></i>
                                    <p>Free Conversation</p>
                                    <p class="text-xs mt-1 opacity-75">Natural chat about anything</p>
                                </button>
                                <button 
                                    @click="practiceType = 'topic'"
                                    :class="practiceType === 'topic' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                    class="p-4 rounded-lg font-semibold transition">
                                    <i class="fas fa-book mb-2 text-2xl"></i>
                                    <p>Topic Discussion</p>
                                    <p class="text-xs mt-1 opacity-75">Talk about educational topics</p>
                                </button>
                                <button 
                                    @click="practiceType = 'presentation'"
                                    :class="practiceType === 'presentation' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                    class="p-4 rounded-lg font-semibold transition">
                                    <i class="fas fa-presentation mb-2 text-2xl"></i>
                                    <p>Presentation</p>
                                    <p class="text-xs mt-1 opacity-75">Present and answer questions</p>
                                </button>
                                <button 
                                    @click="practiceType = 'interview'"
                                    :class="practiceType === 'interview' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                    class="p-4 rounded-lg font-semibold transition">
                                    <i class="fas fa-user-tie mb-2 text-2xl"></i>
                                    <p>Mock Interview</p>
                                    <p class="text-xs mt-1 opacity-75">Practice interview skills</p>
                                </button>
                            </div>
                        </div>
                        
                        <button 
                            @click="startSession()"
                            class="mt-6 px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-bold text-lg hover:from-purple-600 hover:to-pink-600 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                            <i class="fas fa-play mr-2"></i>Start Practice Session
                        </button>
                    </div>

                    <!-- Active Session -->
                    <div x-show="sessionActive && !analyzing" class="space-y-4">
                        <!-- Session Timer -->
                        <div class="flex items-center justify-center space-x-6 text-lg">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-clock text-purple-500"></i>
                                <span class="font-semibold" x-text="formatTime(sessionDuration)"></span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-exchange-alt text-blue-500"></i>
                                <span class="font-semibold"><span x-text="conversation.length"></span> turns</span>
                            </div>
                        </div>

                        <!-- Listening Indicator -->
                        <div class="my-8">
                            <div x-show="isListening" class="space-y-4">
                                <div class="flex items-center justify-center space-x-2">
                                    <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                    <span class="text-red-500 font-semibold">Listening...</span>
                                </div>
                                <!-- Waveform Animation -->
                                <div class="flex items-center justify-center space-x-1">
                                    <div class="w-2 h-8 bg-red-400 rounded animate-waveform" style="animation-delay: 0ms"></div>
                                    <div class="w-2 h-12 bg-red-400 rounded animate-waveform" style="animation-delay: 100ms"></div>
                                    <div class="w-2 h-16 bg-red-500 rounded animate-waveform" style="animation-delay: 200ms"></div>
                                    <div class="w-2 h-10 bg-red-400 rounded animate-waveform" style="animation-delay: 300ms"></div>
                                    <div class="w-2 h-14 bg-red-500 rounded animate-waveform" style="animation-delay: 400ms"></div>
                                    <div class="w-2 h-8 bg-red-400 rounded animate-waveform" style="animation-delay: 500ms"></div>
                                </div>
                                <!-- Interim Transcript -->
                                <p x-show="interimTranscript" class="text-gray-600 italic" x-text="interimTranscript"></p>
                            </div>

                            <div x-show="isSpeaking" class="space-y-4">
                                <div class="flex items-center justify-center space-x-2">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                                    <span class="text-blue-500 font-semibold">AI is speaking...</span>
                                </div>
                                <div class="text-center">
                                    <i class="fas fa-volume-up text-4xl text-blue-500 animate-pulse"></i>
                                </div>
                            </div>

                            <div x-show="!isListening && !isSpeaking" class="text-center">
                                <div class="w-24 h-24 mx-auto bg-purple-100 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-microphone text-4xl text-purple-500"></i>
                                </div>
                                <p class="text-gray-600 font-semibold">Your turn to speak!</p>
                            </div>
                        </div>

                        <!-- Control Buttons -->
                        <div class="flex items-center justify-center space-x-4">
                            <button 
                                @mousedown="startListening()" 
                                @mouseup="stopListening()"
                                @touchstart="startListening()"
                                @touchend="stopListening()"
                                :disabled="isSpeaking"
                                :class="isListening ? 'bg-red-500 animate-pulse' : 'bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600'"
                                class="px-8 py-4 text-white rounded-full font-bold text-lg transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-microphone mr-2"></i>
                                <span x-text="isListening ? 'Release to Send' : 'Hold to Speak'"></span>
                            </button>
                            
                            <button 
                                @click="endSession()"
                                class="px-6 py-4 bg-gray-600 text-white rounded-full font-bold hover:bg-gray-700 transition-all shadow-lg">
                                <i class="fas fa-stop mr-2"></i>End Session
                            </button>
                        </div>
                    </div>

                    <!-- Analyzing -->
                    <div x-show="analyzing" class="space-y-4">
                        <div class="w-24 h-24 mx-auto bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">Analyzing Your Session...</h3>
                        <p class="text-gray-600">Please wait while we evaluate your speaking performance</p>
                        <div class="w-64 mx-auto bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div class="bg-blue-500 h-full rounded-full animate-progress"></div>
                        </div>
                    </div>
                </div>

                <!-- Conversation Display -->
                <div x-show="sessionActive && conversation.length > 0" class="mt-6 border-t pt-6">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-comments mr-2 text-purple-500"></i>
                        Conversation
                    </h3>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        <template x-for="(turn, index) in conversation" :key="index">
                            <div class="flex" :class="turn.speaker === 'student' ? 'justify-end' : 'justify-start'">
                                <div class="max-w-xs rounded-lg p-3" 
                                     :class="turn.speaker === 'student' ? 'bg-purple-100' : 'bg-gray-100'">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <i :class="turn.speaker === 'student' ? 'fas fa-user text-purple-500' : 'fas fa-robot text-blue-500'"></i>
                                        <span class="text-xs font-semibold" x-text="turn.speaker === 'student' ? 'You' : 'AI Tutor'"></span>
                                    </div>
                                    <p class="text-sm" x-text="turn.text"></p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Progress Stats -->
            {% if previous_sessions %}
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-purple-500"></i>
                    Your Progress
                </h3>
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Total Sessions</span>
                            <span class="font-semibold">{{ previous_sessions|length }}</span>
                        </div>
                    </div>
                    {% if previous_sessions %}
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600">Latest Score</span>
                            <span class="font-semibold">{{ previous_sessions.0.overall_score|floatformat:0 }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full" 
                                 style="width: {{ previous_sessions.0.overall_score }}%"></div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <a href="{% url 'students:speaking_practice_history' %}" 
                   class="block mt-4 text-center text-purple-600 hover:text-purple-700 font-semibold text-sm">
                    View Full History →
                </a>
            </div>
            {% endif %}

            <!-- Tips -->
            <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg shadow-lg p-6">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                    Tips for Success
                </h3>
                <ul class="space-y-2 text-sm text-gray-700">
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                        <span>Speak clearly and at a natural pace</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                        <span>Use complete sentences</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                        <span>Try to minimize filler words (um, uh)</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                        <span>Practice for at least 5 minutes</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                        <span>Engage naturally with the AI</span>
                    </li>
                </ul>
            </div>

            <!-- Recent Sessions -->
            {% if previous_sessions %}
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-history mr-2 text-purple-500"></i>
                    Recent Sessions
                </h3>
                <div class="space-y-3">
                    {% for session in previous_sessions|slice:":3" %}
                    <a href="{% url 'students:speaking_practice_detail' session.id %}" 
                       class="block p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-semibold text-gray-700">
                                {{ session.get_practice_type_display }}
                            </span>
                            <span class="text-xs text-gray-500">
                                {{ session.created_at|date:"M d" }}
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-600">Score:</span>
                            <span class="text-sm font-bold" 
                                  :class="{'text-green-600': {{ session.overall_score }} >= 80, 'text-yellow-600': {{ session.overall_score }} >= 60 && {{ session.overall_score }} < 80, 'text-red-600': {{ session.overall_score }} < 60}">
                                {{ session.overall_score|floatformat:0 }}%
                            </span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
@keyframes waveform {
    0%, 100% { height: 2rem; }
    50% { height: 4rem; }
}

.animate-waveform {
    animation: waveform 0.8s ease-in-out infinite;
}

@keyframes progress {
    0% { width: 0%; }
    100% { width: 100%; }
}

.animate-progress {
    animation: progress 3s ease-in-out infinite;
}
</style>

<script>
function speakingPractice() {
    return {
        // Session state
        sessionActive: false,
        analyzing: false,
        practiceType: 'free',
        sessionStartTime: null,
        sessionDuration: 0,
        durationTimer: null,
        
        // Voice state
        isListening: false,
        isSpeaking: false,
        recognition: null,
        synthesis: window.speechSynthesis,
        interimTranscript: '',
        
        // Conversation
        conversation: [],
        
        // Initialize
        init() {
            this.initVoiceRecognition();
        },
        
        // Initialize speech recognition
        initVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('Speech Recognition not supported');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            this.recognition = new SpeechRecognition();
            this.recognition.continuous = false;
            this.recognition.interimResults = true;
            this.recognition.lang = 'en-IN';
            
            this.recognition.onstart = () => {
                this.isListening = true;
                this.interimTranscript = '';
            };
            
            this.recognition.onresult = (event) => {
                let interim = '';
                let final = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        final += transcript;
                    } else {
                        interim += transcript;
                    }
                }
                
                if (interim) {
                    this.interimTranscript = interim;
                }
                
                if (final) {
                    this.handleStudentMessage(final);
                }
            };
            
            this.recognition.onend = () => {
                this.isListening = false;
                this.interimTranscript = '';
            };
            
            this.recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                this.isListening = false;
            };
        },
        
        // Start practice session
        startSession() {
            this.sessionActive = true;
            this.sessionStartTime = Date.now();
            this.conversation = [];
            
            // Start duration timer
            this.durationTimer = setInterval(() => {
                this.sessionDuration = Math.floor((Date.now() - this.sessionStartTime) / 1000);
            }, 1000);
            
            // Initial AI greeting
            this.addAIMessage("Hello! I'm your AI speaking tutor. Let's have a conversation to help improve your English. What would you like to talk about?");
            this.speakMessage("Hello! I'm your AI speaking tutor. Let's have a conversation to help improve your English. What would you like to talk about?");
        },
        
        // Start listening
        startListening() {
            if (!this.recognition || this.isListening || this.isSpeaking) return;
            
            // Stop any ongoing speech
            if (this.synthesis.speaking) {
                this.synthesis.cancel();
                this.isSpeaking = false;
            }
            
            try {
                this.recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
            }
        },
        
        // Stop listening
        stopListening() {
            if (!this.recognition || !this.isListening) return;
            
            try {
                this.recognition.stop();
            } catch (error) {
                console.error('Error stopping recognition:', error);
            }
        },
        
        // Handle student message
        async handleStudentMessage(message) {
            // Add to conversation
            this.conversation.push({
                speaker: 'student',
                text: message,
                timestamp: new Date().toISOString()
            });
            
            // Get AI response
            await this.getAIResponse(message);
        },
        
        // Get AI response
        async getAIResponse(studentMessage) {
            try {
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || this.getCookie('csrftoken');
                
                const response = await fetch('{% url "students:speaking_practice_respond" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        student_message: studentMessage,
                        conversation_history: this.conversation,
                        practice_type: this.practiceType
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    this.addAIMessage(data.response);
                    this.speakMessage(data.response);
                }
            } catch (error) {
                console.error('Error getting AI response:', error);
            }
        },
        
        // Add AI message to conversation
        addAIMessage(message) {
            this.conversation.push({
                speaker: 'ai',
                text: message,
                timestamp: new Date().toISOString()
            });
        },
        
        // Speak message using TTS
        speakMessage(text) {
            if (!this.synthesis) return;
            
            this.synthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-IN';
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            
            utterance.onstart = () => {
                this.isSpeaking = true;
            };
            
            utterance.onend = () => {
                this.isSpeaking = false;
            };
            
            utterance.onerror = () => {
                this.isSpeaking = false;
            };
            
            this.synthesis.speak(utterance);
        },
        
        // End session and analyze
        async endSession() {
            if (!confirm('Are you sure you want to end this session? Your conversation will be analyzed.')) {
                return;
            }
            
            clearInterval(this.durationTimer);
            this.sessionActive = false;
            this.analyzing = true;
            
            // Stop any ongoing speech
            if (this.synthesis.speaking) {
                this.synthesis.cancel();
            }
            
            // Send for analysis
            try {
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || this.getCookie('csrftoken');
                
                const response = await fetch('{% url "students:analyze_speaking_session" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        conversation: this.conversation,
                        duration: this.sessionDuration,
                        practice_type: this.practiceType
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success' && data.session_id) {
                    // Redirect to results page
                    window.location.href = `/students/speaking-practice/detail/${data.session_id}/`;
                } else {
                    alert('Error analyzing session. Please try again.');
                    this.analyzing = false;
                }
            } catch (error) {
                console.error('Error analyzing session:', error);
                alert('Error analyzing session. Please try again.');
                this.analyzing = false;
            }
        },
        
        // Format time
        formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        },
        
        // Get cookie
        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    };
}
</script>
{% endblock %}
